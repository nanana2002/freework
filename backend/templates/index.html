<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAMER</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
    <link rel="icon" href="/static/icons/favicon.svg" type="image/svg+xml">
    <script>
        // Tailwind é…ç½®ï¼ˆä»…å®šä¹‰ï¼Œä¸æ¶‰åŠDOMæ“ä½œï¼‰
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#B0DB9C',
                        accent: '#8B5CF6',
                        orange: '#CAE8BD',
                        light: '#F8FAFC'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass {
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            }
            .timer-hidden {
                transform: translateX(calc(100% - 40px));
            }
            .timer-visible {
                transform: translateX(0);
            }
        }
    </style>
    
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ä¹¦æ¶æ ·å¼ */
        .book-shelf {
            perspective: 1000px;
        }
        
        .book {
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .book:hover {
            transform: rotateY(-10deg) translateZ(20px);
        }
        
        /* 1024æ¸¸æˆæ ·å¼ */
        #game-1024 .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        #game-1024 .cell {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        /* æ‰«é›·æ¸¸æˆæ ·å¼ */
        #game-minesweeper .board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            margin: 0 auto;
        }
        
        #game-minesweeper .cell {
            aspect-ratio: 1/1;
            background-color: #E6B89C;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
        }
        
        #game-minesweeper .cell.flagged::before {
            content: "ğŸš©";
        }
        
        #game-minesweeper .cell.mine::before {
            content: "ğŸ’£";
        }
        
        /* å¤‡å¿˜å½•æ ·å¼ */
        .note-card {
            transition: all 0.3s ease;
        }
        
        .note-card:hover {
            transform: translateY(-5px);
        }
        
        .note-editor-toolbar button {
            transition: all 0.2s ease;
        }
        
        .note-editor-toolbar button:hover {
            background-color: #e2e8f0;
        }
        
        .note-content {
            min-height: 300px;
            outline: none;
        }
        
        /* PDFæŸ¥çœ‹å™¨åŠ è½½çŠ¶æ€ */
        .pdf-loading {
            animation: spin 1.5s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ä¹¦ç±å°é¢æ ·å¼ */
        .book-cover {
            height: 48;
            object-fit: cover; /* ç¡®ä¿å›¾ç‰‡è¦†ç›–æ•´ä¸ªåŒºåŸŸ */
            width: 100%;
        }

        /* TXTé˜…è¯»å™¨æ ·å¼ */
        #txt-reader {
            transition: background-color 0.3s;
            scroll-behavior: smooth;
            height: 100%; 
            overflow-y: scroll; 
        }
        
        .txt-page {
            min-height: 100%; 
            padding: 1rem 5rem;
            line-height: 1.8;
            font-size: 1.1rem;
            white-space: pre-wrap; 
        }
        
        .bg-light-mode { background-color: #F8FAFC; color: #1E293B; }
        .bg-sepia-mode { background-color: #f7f3e8; color: #5a4a35; }
        .bg-dark-mode { background-color: #1E293B; color: #F8FAFC; }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto px-4 py-8">
        <nav class="mb-8 bg-white rounded-xl p-4 card-shadow">
            <div class="flex flex-wrap justify-center gap-2 md:gap-4">
                <button class="nav-btn active px-4 py-2 rounded-lg transition flex items-center" data-page="dashboard">
                    <i class="fa fa-home mr-2"></i> ä»ªè¡¨ç›˜
                </button>
                <button class="nav-btn px-4 py-2 rounded-lg transition flex items-center" data-page="timer">
                    <i class="fa fa-clock-o mr-2"></i> è®¡æ—¶å™¨
                </button>
                <button class="nav-btn px-4 py-2 rounded-lg transition flex items-center" data-page="books">
                    <i class="fa fa-book mr-2"></i> ä¹¦æ¶
                </button>
                <button class="nav-btn px-4 py-2 rounded-lg transition flex items-center" data-page="music">
                    <i class="fa fa-music mr-2"></i> éŸ³ä¹
                </button>
                <button class="nav-btn px-4 py-2 rounded-lg transition flex items-center" data-page="games">
                    <i class="fa fa-gamepad mr-2"></i> æ¸¸æˆ
                </button>
                <button class="nav-btn px-4 py-2 rounded-lg transition flex items-center" data-page="notes">
                    <i class="fa fa-sticky-note mr-2"></i> å¤‡å¿˜å½•
                </button>
                <button class="nav-btn px-4 py-2 rounded-lg transition flex items-center" data-page="chat">
                    <i class="fa fa-comments mr-2"></i> å¯¹è¯
                </button>
                <!-- ä¹¦ç­¾å¯¼èˆªæŒ‰é’® -->
                <button class="nav-btn px-4 py-2 rounded-lg transition flex items-center" data-page="bookmarks">
                    <i class="fa fa-bookmark mr-2"></i> ä¹¦ç­¾
                </button>
            </div>
        </nav>

        <div id="dashboard" class="page active">
            <div class="bg-white rounded-xl p-6 mb-6 card-shadow">
                <h2 class="text-2xl font-bold mb-4">æ¬¢è¿æ¥åˆ°å·¥ä½œç©ºé—´</h2>
                <p class="text-gray-600 mb-6">è¿™é‡Œé›†æˆäº†æ‚¨éœ€è¦çš„å„ç§å·¥å…·ï¼Œå¸®åŠ©æ‚¨æ›´é«˜æ•ˆåœ°å·¥ä½œå’Œæ”¾æ¾ã€‚</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 hover:shadow-lg transition cursor-pointer card-shadow" onclick="navigateTo('timer')">
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-clock-o text-primary text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">å·¥ä½œè®¡æ—¶å™¨</h3>
                        <p class="text-gray-600">è®¾ç½®ä»Šæ—¥å·¥ä½œæ—¶é•¿ï¼Œè·Ÿè¸ªå‰©ä½™æ—¶é—´</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-teal-50 rounded-xl p-5 hover:shadow-lg transition cursor-pointer card-shadow" onclick="navigateTo('books')">
                        <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-book text-secondary text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">æˆ‘çš„ä¹¦æ¶</h3>
                        <p class="text-gray-600">ä¸Šä¼ å’Œç®¡ç†æ–‡æ¡£</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-5 hover:shadow-lg transition cursor-pointer card-shadow" onclick="navigateTo('music')">
                        <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-music text-accent text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">éŸ³ä¹æ’­æ”¾å™¨</h3>
                        <p class="text-gray-600">è®¿é—®æ‚¨çš„ç½‘æ˜“äº‘æ”¶è—éŸ³ä¹</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-5 hover:shadow-lg transition cursor-pointer card-shadow" onclick="navigateTo('games')">
                        <div class="bg-yellow-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-gamepad text-yellow-600 text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">ä¼‘é—²æ¸¸æˆ</h3>
                        <p class="text-gray-600">å·¥ä½œé—´éš™æ”¾æ¾ä¸€ä¸‹</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-red-50 to-rose-50 rounded-xl p-5 hover:shadow-lg transition cursor-pointer card-shadow" onclick="navigateTo('notes')">
                        <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-sticky-note text-red-500 text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">å¤‡å¿˜å½•</h3>
                        <p class="text-gray-600">è®°å½•æƒ³æ³•å’Œå¾…åŠäº‹é¡¹</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl p-5 hover:shadow-lg transition cursor-pointer card-shadow" onclick="navigateTo('chat')">
                        <div class="bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-comments text-indigo-500 text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">AIå¯¹è¯</h3>
                        <p class="text-gray-600">ä¸å¤§è¯­è¨€æ¨¡å‹å¯¹è¯</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl p-5 hover:shadow-lg transition cursor-pointer card-shadow" onclick="navigateTo('bookmarks')">
                        <div class="bg-gray-300 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-bookmark text-gray-700 text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">ä¹¦ç­¾</h3>
                        <p class="text-gray-600">å¿«é€Ÿè®¿é—®å¸¸ç”¨ç½‘å€</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h3 class="font-bold text-xl mb-4">ä»Šæ—¥çŠ¶æ€</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-gray-500 mb-2">å·²å·¥ä½œæ—¶é—´</h4>
                        <p id="today-worked" class="text-2xl font-bold">0å°æ—¶0åˆ†é’Ÿ</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-gray-500 mb-2">å·²åˆ›å»ºå¤‡å¿˜å½•</h4>
                        <p id="today-notes" class="text-2xl font-bold">0ç¯‡</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="timer" class="page">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-2xl font-bold mb-6">å·¥ä½œè®¡æ—¶å™¨</h2>
                
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <p class="text-gray-500 mb-2">ä»Šæ—¥å·¥ä½œç›®æ ‡</p>
                        <div class="flex items-center justify-center gap-3 mb-2">
                            <input type="number" id="timer-page-hours" value="7" min="0.5" step="0.5" 
                                   class="w-20 border rounded p-2 text-center text-xl">
                            <span class="text-xl">å°æ—¶</span>
                        </div>
                        <p class="text-gray-500 mb-4">é¢„è®¡ä¸‹ç­æ—¶é—´: <span id="timer-page-end-time" class="font-medium">19:49</span></p>
                        <div id="timer-page-display" class="text-6xl font-bold mb-6">07:00:00</div>
                        
                        <div class="flex justify-center gap-4">
                            <button id="timer-page-start" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition text-lg">
                                <i class="fa fa-play mr-2"></i> å¼€å§‹å·¥ä½œ
                            </button>
                            <button id="timer-page-pause" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg transition text-lg hidden">
                                <i class="fa fa-pause mr-2"></i> æš‚åœ
                            </button>
                            <button id="timer-page-reset" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg transition text-lg">
                                <i class="fa fa-refresh mr-2"></i> é‡ç½®
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="font-bold text-lg mb-4">å·¥ä½œè®°å½•</h3>
                        <!-- æ‰‹åŠ¨æ·»åŠ è®°å½•è¡¨å• -->
                        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                            <h4 class="font-semibold mb-2 flex items-center">
                                <i class="fa fa-plus-circle mr-2 text-primary"></i> æ‰‹åŠ¨æ·»åŠ è®°å½•
                            </h4>
                            <div class="flex flex-wrap items-end gap-3">
                                <div class="flex-1 min-w-[100px]">
                                    <label class="text-sm text-gray-600 block mb-1">æ—¶é•¿ (å°æ—¶)</label>
                                    <input type="number" id="manual-hours" min="0.5" step="0.5" value="1" 
                                           class="w-full border rounded p-2 text-center">
                                </div>
                                <div class="flex-1 min-w-[150px]">
                                    <label class="text-sm text-gray-600 block mb-1">æ—¥æœŸ</label>
                                    <input type="date" id="manual-date" 
                                           class="w-full border rounded p-2">
                                </div>
                                <button id="add-manual-record" 
                                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition flex-shrink-0">
                                    <i class="fa fa-save mr-1"></i> æ·»åŠ 
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3" id="work-records">
                            <div class="text-gray-500 text-center py-4">æš‚æ— å·¥ä½œè®°å½•</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="books" class="page">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex flex-wrap justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">æˆ‘çš„ä¹¦æ¶</h2>
                    <button id="upload-pdf-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition flex items-center">
                        <i class="fa fa-upload mr-2"></i> ä¸Šä¼ æ–‡æ¡£ (.pdf / .txt)
                    </button>
                </div>
                
                <div id="upload-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold mb-4">ä¸Šä¼ æ–‡æ¡£</h3>
                        <form id="pdf-upload-form">
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2" for="pdf-title">æ–‡æ¡£æ ‡é¢˜ (ç”¨äºå‘½å)</label>
                                <input type="text" id="pdf-title" class="w-full border rounded p-2" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2" for="pdf-file">é€‰æ‹©æ–‡æ¡£ (.pdf, .txt)</label>
                                <input type="file" id="pdf-file" accept=".pdf,.txt" class="w-full border rounded p-2" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2" for="pdf-cover">é€‰æ‹©å°é¢å›¾ç‰‡ (å¯é€‰)</label>
                                <input type="file" id="pdf-cover" accept="image/*" class="w-full border rounded p-2">
                            </div>
                            <!-- TXTç¼–ç é€‰æ‹© -->
                            <div class="mb-4" id="txt-encoding-div" style="display: none;">
                                <label class="block text-gray-700 mb-2" for="file-encoding">æ–‡æ¡£ç¼–ç  (ä»…TXT)</label>
                                <select id="file-encoding" class="w-full border rounded p-2">
                                    <option value="utf-8">UTF-8 (æ¨è)</option>
                                    <option value="gbk">GBK</option>
                                    <option value="gb2312">GB2312</option>
                                    <option value="gb18030">GB18030</option>
                                    <option value="big5">Big5</option>
                                    <option value="windows-1252">ANSI/Windows-1252</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button type="button" id="cancel-upload" class="border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                                    å–æ¶ˆ
                                </button>
                                <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition">
                                    ä¸Šä¼ 
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="book-shelf grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6" id="book-shelf">
                    <!-- ä¹¦ç±å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
        
        <!-- PDF é˜…è¯»å™¨ -->
        <div id="pdf-reader" class="mt-8 hidden">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 id="pdf-viewer-title" class="font-bold text-lg"></h3>
                    <button id="close-pdf-reader" class="text-gray-500 hover:text-gray-800 p-2">
                        <i class="fa fa-times text-xl"></i> å…³é—­é˜…è¯»å™¨
                    </button>
                </div>
                <div class="flex-1 overflow-auto p-4" style="max-height: 70vh;">
                    <div id="pdf-container" class="bg-white min-h-[600px] flex justify-center items-center">
                        </div>
                </div>
                <div class="p-4 border-t flex justify-between items-center">
                    <div class="flex items-center">
                        <span id="pdf-page-info">ç¬¬ 1 é¡µ / å…± ? é¡µ</span>
                        <div class="ml-4 flex items-center" id="pdf-navigation">
                            <label for="pdf-page-input">è·³è½¬åˆ°ç¬¬</label>
                            <input type="number" id="pdf-page-input" class="w-16 border rounded p-1 mx-1 text-dark" min="1">
                            <button id="pdf-jump-btn" class="bg-primary text-white px-2 py-1 rounded">é¡µ</button>
                        </div>
                    </div>
                    <div class="flex gap-2" id="pdf-buttons">
                        <button id="pdf-prev-page" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸Šä¸€é¡µ
                        </button>
                        <button id="pdf-next-page" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸‹ä¸€é¡µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TXT é˜…è¯»å™¨ -->
        <div id="txt-reader-modal" class="fixed inset-0 z-50 hidden flex flex-col">
            <header class="bg-orange text-light p-3 flex justify-between items-center flex-shrink-0">
                <h3 id="txt-viewer-title" class="text-xl font-bold"></h3>
                <div class="flex items-center space-x-3">
                    <label for="bg-mode" class="text-sm">èƒŒæ™¯:</label>
                    <select id="bg-mode" class="text-dark p-1 rounded">
                        <option value="light-mode">ç™½å¤©</option>
                        <option value="sepia-mode">ç¾Šçš®çº¸</option>
                        <option value="dark-mode">å¤œé—´</option>
                    </select>
                    <button id="close-txt-reader" class="text-light hover:text-red-400 text-2xl">
                        <i class="fa fa-times-circle"></i>
                    </button>
                </div>
                <!-- åœ¨TXTé˜…è¯»å™¨å·¥å…·æ æ·»åŠ ç¼–ç é€‰æ‹© -->
                <div class="txt-encoding-selector mb-2">
                    <label for="txt-display-encoding">æ˜¾ç¤ºç¼–ç ï¼š</label>
                    <select id="txt-display-encoding" class="text-dark p-1 rounded">
                        <option value="utf-8">UTF-8</option>
                        <option value="gbk">GBK</option>
                        <option value="gb2312">GB2312</option>
                        <option value="gb18030">GB18030</option>
                        <option value="big5">Big5</option>
                        <option value="windows-1252">ANSI/Windows-1252</option>
                    </select>
                </div>
            </header>
            <div id="txt-reader" class="flex-grow overflow-hidden bg-light-mode" tabindex="0">
                <div id="txt-content" class="txt-page mx-auto" style="max-width: 800px;">
                    <!-- æ–‡æœ¬å†…å®¹å°†åœ¨è¿™é‡ŒåŠ è½½ -->
                </div>
            </div>
            <footer class="bg-orange text-light p-2 flex justify-center items-center flex-shrink-0">
                <div class="flex items-center">
                    <label for="txt-page-input">è·³è½¬åˆ°ç¬¬</label>
                    <input type="number" id="txt-page-input" class="w-16 border rounded p-1 mx-1 text-dark" min="1">
                    <button id="txt-jump-btn" class="bg-primary px-2 py-1 rounded text-light">é¡µ</button>
                </div>
                <span id="txt-page-info" class="mx-4">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                <button id="txt-prev-page" class="mx-3 px-3 py-1 bg-primary hover:bg-blue-600 rounded">
                    <i class="fa fa-arrow-up"></i> ä¸Šä¸€é¡µ
                </button>
                <button id="txt-next-page" class="mx-3 px-3 py-1 bg-primary hover:bg-blue-600 rounded">
                    <i class="fa fa-arrow-down"></i> ä¸‹ä¸€é¡µ
                </button>
            </footer>
        </div>

        <div id="music" class="page">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-2xl font-bold mb-6">éŸ³ä¹æ’­æ”¾å™¨</h2>
                
                <div class="mb-6">
                    <h3 class="font-bold text-lg mb-3">ç½‘æ˜“äº‘æ­Œå•è®¾ç½®</h3>
                    <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
                        <input type="text" id="netease-playlist-id" 
                            value="877029680" placeholder="è¾“å…¥ç½‘æ˜“äº‘æ­Œå•IDï¼ˆä»æ­Œå•URLä¸­æå–ï¼‰"
                            class="flex-1 border rounded p-2">
                        <button id="save-music-setting" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition">
                            ä¿å­˜è®¾ç½®
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mt-4">
                        <label for="music-order" class="text-gray-700 font-medium">æ’­æ”¾æ¨¡å¼</label>
                        <select id="music-order" class="border rounded p-2">
                            <option value="list">é¡ºåºæ’­æ”¾</option>
                            <option value="random">éšæœºæ’­æ”¾</option>
                        </select>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        æ­Œå•IDè·å–æ–¹å¼ï¼šç½‘æ˜“äº‘æ­Œå•URLä¸­ "id=" åé¢çš„æ•°å­—ï¼ˆä¾‹ï¼šhttps://music.163.com/playlist?id=877029680 â†’ IDä¸º877029680ï¼‰
                    </p>
                </div>
                
                <div class="border rounded-lg overflow-hidden bg-gray-50 p-4">
                    <div id="music-player" class="aplayer">
                        </div>
                    <div class="flex justify-center mt-4 space-x-4">
                        <button id="music-prev" class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fa fa-step-backward"></i> ä¸Šä¸€é¦–
                        </button>
                        <button id="music-play-pause" class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i id="play-pause-icon" class="fa fa-play"></i> æ’­æ”¾/æš‚åœ
                        </button>
                        <button id="music-next" class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            ä¸‹ä¸€é¦– <i class="fa fa-step-forward"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div id="games" class="page">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-2xl font-bold mb-6">ä¼‘é—²æ¸¸æˆ</h2>
                
                <div class="mb-6">
                    <h3 class="font-bold text-lg mb-3">é€‰æ‹©æ¸¸æˆ</h3>
                    <div class="flex flex-wrap gap-3">
                        <button class="game-selector active bg-primary text-white px-4 py-2 rounded-lg transition" data-game="1024">
                            1024æ¸¸æˆ
                        </button>
                        <button class="game-selector bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition" data-game="minesweeper">
                            æ‰«é›·
                        </button>
                        <button id="upload-game-btn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fa fa-upload mr-2"></i> ä¸Šä¼ æ¸¸æˆ
                        </button>
                    </div>
                </div>
                
                <div class="max-w-2xl mx-auto">
                    <!-- 1024æ¸¸æˆ -->
                    <div id="game-1024" class="game-content">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-gray-600">åˆ†æ•°</p>
                                    <p id="score-1024" class="text-2xl font-bold">0</p>
                                </div>
                                <button id="restart-1024" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                                    é‡æ–°å¼€å§‹
                                </button>
                            </div>
                            <div class="bg-gray-200 p-3 rounded-lg">
                                <div class="grid" id="grid-1024">
                                    </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-4 text-center">
                                ä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨æ–¹å—ï¼Œç›¸åŒæ•°å­—ç¢°æ’å°†åˆå¹¶
                            </p>
                        </div>
                    </div>
                    
                    <!-- æ‰«é›·æ¸¸æˆ -->
                    <div id="minesweeper" class="game-content hidden">
                        <iframe id="minesweeper-frame" src="/static/games/minesweeper.html" 
                                class="w-full h-[600px] border-none" title="æ‰«é›·æ¸¸æˆ"></iframe>
                    </div>
                    
                    <!-- ä¸Šä¼ æ¸¸æˆå†…å®¹ -->
                    <div id="game-upload" class="game-content hidden">
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h4 class="font-semibold mb-2 flex items-center">
                                <i class="fa fa-plus-circle mr-2 text-primary"></i> ä¸Šä¼ è‡ªå®šä¹‰æ¸¸æˆ
                            </h4>
                            <div class="flex flex-wrap items-end gap-3">
                                <div class="flex-1 min-w-[150px]">
                                    <label class="text-sm text-gray-600 block mb-1">æ¸¸æˆåç§°</label>
                                    <input type="text" id="game-name" class="w-full border rounded p-2" placeholder="è¾“å…¥æ¸¸æˆåç§°">
                                </div>
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-sm text-gray-600 block mb-1">é€‰æ‹©æ¸¸æˆæ–‡ä»¶</label>
                                    <input type="file" id="game-file" accept=".html,.htm,.js,.zip" class="w-full border rounded p-2">
                                </div>
                                <button id="upload-game-submit" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition flex-shrink-0">
                                    <i class="fa fa-upload mr-1"></i> ä¸Šä¼ 
                                </button>
                            </div>
                        </div>
                        <div id="custom-games-list" class="mt-6">
                            <h4 class="font-semibold mb-2">æˆ‘çš„ä¸Šä¼ æ¸¸æˆ</h4>
                            <div id="custom-games-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- è‡ªå®šä¹‰æ¸¸æˆå°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="notes" class="page">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex flex-wrap justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">å¤‡å¿˜å½•</h2>
                    <button id="create-note-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition flex items-center">
                        <i class="fa fa-plus mr-2"></i> æ–°å»ºå¤‡å¿˜å½•
                    </button>
                </div>
                
                <div id="notes-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                    <!-- å¤‡å¿˜å½•åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
                
                <div id="note-editor" class="border border-gray-200 rounded-lg overflow-hidden hidden flex flex-col h-[70vh]">
                    <div class="border-b p-4 flex justify-between items-center">
                        <input type="text" id="note-title" placeholder="è¯·è¾“å…¥æ ‡é¢˜..." class="text-xl font-bold border-none outline-none w-full">
                        <div class="flex gap-2">
                            <button id="delete-note-btn" class="text-red-500 hover:text-red-700 p-2">
                                <i class="fa fa-trash"></i>
                            </button>
                            <button id="close-note-btn" class="text-gray-500 hover:text-gray-800 p-2">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="note-editor-toolbar border-b p-2 flex flex-wrap gap-1 bg-gray-50">
                        <button id="format-bold" class="p-2 rounded hover:bg-gray-200" title="ç²—ä½“ (Ctrl+B)">
                            <i class="fa fa-bold"></i>
                        </button>
                        <button id="format-italic" class="p-2 rounded hover:bg-gray-200" title="æ–œä½“ (Ctrl+I)">
                            <i class="fa fa-italic"></i>
                        </button>
                        <span class="h-6 border-r border-gray-300 mx-1"></span>
                        <button id="format-heading" class="p-2 rounded hover:bg-gray-200" title="æ ‡é¢˜">
                            <i class="fa fa-header"></i>
                        </button>
                        <button id="format-list-ul" class="p-2 rounded hover:bg-gray-200" title="æ— åºåˆ—è¡¨">
                            <i class="fa fa-list-ul"></i>
                        </button>
                        <button id="format-list-ol" class="p-2 rounded hover:bg-gray-200" title="æœ‰åºåˆ—è¡¨">
                            <i class="fa fa-list-ol"></i>
                        </button>
                        <span class="h-6 border-r border-gray-300 mx-1"></span>
                        <button id="format-link" class="p-2 rounded hover:bg-gray-200" title="æ’å…¥é“¾æ¥">
                            <i class="fa fa-link"></i>
                        </button>
                        <label class="p-2 rounded hover:bg-gray-200 cursor-pointer" title="æ’å…¥å›¾ç‰‡">
                            <i class="fa fa-image"></i>
                            <input type="file" id="insert-image" accept="image/*" class="hidden">
                        </label>
                        <span class="h-6 border-r border-gray-300 mx-1"></span>
                        <button id="preview-note-btn" class="p-2 rounded hover:bg-gray-200" title="é¢„è§ˆ">
                            <i class="fa fa-eye"></i> é¢„è§ˆ
                        </button>
                        <button id="save-note-btn" class="p-2 rounded hover:bg-gray-200 ml-auto" title="ä¿å­˜ (Ctrl+S)">
                            <i class="fa fa-save"></i> ä¿å­˜
                        </button>
                    </div>
                    
                    <div class="flex flex-1 overflow-hidden">
                        <div class="w-1/2 border-r">
                            <textarea id="note-content-md" class="w-full h-full p-4 border-none outline-none resize-none font-mono text-sm" placeholder="åœ¨æ­¤è¾“å…¥ Markdown å†…å®¹..."></textarea>
                        </div>
                        <div id="note-preview" class="w-1/2 p-4 overflow-y-auto bg-white">
                            <!-- Markdown é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                            <div class="prose max-w-none">åœ¨æ­¤è¾“å…¥ Markdown å†…å®¹ä»¥é¢„è§ˆ...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat" class="page">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- å¯¹è¯åˆ—è¡¨ä¾§è¾¹æ  -->
                    <div class="md:w-1/4 border rounded-lg overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="font-bold">å¯¹è¯åˆ—è¡¨</h3>
                            <button id="new-conversation" class="bg-primary hover:bg-primary/90 text-white p-2 rounded">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                        <div id="conversations-list" class="max-h-[500px] overflow-y-auto">
                            <!-- å¯¹è¯åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- å¯¹è¯å†…å®¹åŒºåŸŸ -->
                    <div class="md:w-3/4 flex flex-col">                    
                        <div class="mb-6">
                            <h2 class="font-bold text-lg mb-3">Qwen API è®¾ç½®</h2>
                            <!-- å¤–å±‚ä½¿ç”¨ flex å®¹å™¨åŒ…è£¹ä¸¤ä¸ªè¾“å…¥åŒºåŸŸ -->
                            <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                                <!-- å·¦ä¾§ API å¯†é’¥åŒºåŸŸ -->
                                <div class="flex-1">
                                    <input type="password" id="qwen-api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„Qwen APIå¯†é’¥" 
                                        class="w-full border rounded p-2">
                                </div>
                                <!-- ä¸­é—´æ¨¡å‹ç±»å‹é€‰æ‹©åŒºåŸŸ -->
                                <div class="w-full sm:w-auto">
                                    <label for="model-type" class="block text-sm font-medium text-gray-700 mb-1 sm:mb-0">æ¨¡å‹ç±»å‹</label>
                                    <select id="model-type" class="w-full sm:w-auto border rounded p-2">
                                        <option value="qwen-turbo">Qwen-Turbo</option>
                                        <option value="qwen-max">Qwen-Max</option>
                                        <option value="qwen-plus">Qwen-Plus</option>
                                    </select>
                                </div>
                                <!-- å³ä¾§ä¿å­˜æŒ‰é’® -->
                                <button id="save-api-key" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition">
                                    ä¿å­˜å¯†é’¥
                                </button>
                            </div>
                        </div>
                        
                        <div class="border rounded-lg overflow-hidden flex flex-col h-[600px]">
                            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                                <!-- æ¶ˆæ¯å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            
                            <div class="border-t p-4">
                                <form id="chat-form" class="flex gap-3">
                                    <textarea id="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                                            class="flex-1 border rounded p-2 resize-none" rows="3"></textarea>
                                    <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition flex-shrink-0">
                                        <i class="fa fa-paper-plane"></i>
                                    </button>
                                </form>
                                <div id="chat-status" class="text-sm text-gray-500 mt-2 hidden">
                                    <i class="fa fa-circle-o-notch fa-spin"></i> æ€è€ƒä¸­...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="bookmarks" class="page">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-2xl font-bold mb-6">å¿«é€Ÿä¹¦ç­¾</h2>
                
                <div class="flex flex-wrap items-end gap-3 mb-6 p-4 border rounded-lg bg-gray-50">
                    <div class="flex-1 min-w-[150px]">
                        <label class="text-sm text-gray-600 block mb-1" for="bookmark-title">æ ‡é¢˜</label>
                        <input type="text" id="bookmark-title" placeholder="å¦‚ï¼šFlask æ–‡æ¡£" class="w-full border rounded p-2">
                    </div>
                    <div class="flex-1 min-w-[250px]">
                        <label class="text-sm text-gray-600 block mb-1" for="bookmark-url">ç½‘å€ (URL)</label>
                        <input type="url" id="bookmark-url" placeholder="å¦‚ï¼šhttps://flask.palletsprojects.com" class="w-full border rounded p-2">
                    </div>
                    <button id="add-bookmark" class="bg-primary hover:bg-teal-600 text-white px-4 py-2 rounded-lg transition flex-shrink-0">
                        <i class="fa fa-plus mr-1"></i> æ·»åŠ ä¹¦ç­¾
                    </button>
                </div>
                
                <div id="bookmarks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- ä¹¦ç­¾å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                    <div class="text-gray-500 text-center py-4 col-span-full">æš‚æ— ä¹¦ç­¾</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-orange text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p> DREAMER &copy; 2025</p>
        </div>
    </footer>

    <script src="https://cdn.bootcdn.net/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <script>
        // PDF.jsé…ç½®ï¼ˆä¾èµ–pdf.min.jså·²åŠ è½½ï¼‰
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.bootcdn.net/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ----------------------------------------------------
        // æ ¸å¿ƒå¯¼èˆªå‡½æ•° (æ”¾åœ¨é¡¶éƒ¨è§£å†³ ReferenceError)
        // ----------------------------------------------------
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            if (pageId !== 'books') {
                document.getElementById('pdf-reader').classList.add('hidden');
                const shelfArea = document.querySelector('.book-shelf')?.parentElement;
                if (shelfArea) {
                    shelfArea.classList.remove('hidden');
                }
            }
        }

        function navigateTo(pageId) {
            const navButton = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
            if (navButton) {
                navButton.click();
            }
        }
        
        // ----------------------------------------------------
        // å…¨å±€å˜é‡
        // ----------------------------------------------------
        let timerInterval = null;
        let workGoalTime = 7 * 60 * 60; // ç›®æ ‡æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
        let remainingTime = 7 * 60 * 60; // å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
        let isTimerRunning = false;
        let workRecords = []; // { id, date, time, hours, manual }
        let pdfBooks = []; // { id, title, date, file_path, file_type, cover_url, scroll_pos }
        let notes = [];
        let bookmarks = []; // { id, title, url }
        let currentNoteId = null;
        let pdfDoc = null;
        let currentPdfPage = 1;
        let currentTxtBookId = null; // å½“å‰é˜…è¯»çš„TXTä¹¦ç±ID
        let baseRemainingTime = 7 * 60 * 60; // åŸºç¡€å‰©ä½™æ—¶é—´ï¼ˆä¸åŒ…å«å½“å‰è®¡æ—¶å˜åŠ¨ï¼‰

        // ä¿®æ­£ PDF å°é¢ï¼šä½¿ç”¨æ›´ç¨³å®šçš„ Jsdelivr SVG
        const DEFAULT_PDF_COVER = '/uploads/images/file-earmark-pdf.svg'; // å‡å®šæ‚¨å°†æ­¤SVGæ”¾åœ¨åç«¯é™æ€ç›®å½•
        const DEFAULT_TXT_COVER = '/uploads/images/file-earmark-text.svg';

        // ----------------------------------------------------
        // å¯¼èˆªé€»è¾‘
        // ----------------------------------------------------
        function initNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    navButtons.forEach(btn => btn.classList.remove('active', 'bg-primary', 'text-white'));
                    navButtons.forEach(btn => btn.classList.add('hover:bg-gray-100'));
                    
                    this.classList.add('active', 'bg-primary', 'text-white');
                    this.classList.remove('hover:bg-gray-100');
                    
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });
            
            document.querySelector('.nav-btn.active').classList.add('bg-primary', 'text-white');
            document.querySelector('.nav-btn.active').classList.remove('hover:bg-gray-100');
        }
        
        // ----------------------------------------------------
        // åˆå§‹åŒ–è®¡æ—¶å™¨
        // ----------------------------------------------------
        function initTimer() {
            // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
            const elements = {
                startBtn: document.getElementById('timer-page-start'),
                pauseBtn: document.getElementById('timer-page-pause'),
                resetBtn: document.getElementById('timer-page-reset'),
                hoursInput: document.getElementById('timer-page-hours'),
                addRecordBtn: document.getElementById('add-manual-record'),
                dateInput: document.getElementById('manual-date'),
                manualHoursInput: document.getElementById('manual-hours')
            };

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆä»…å½“å…ƒç´ å­˜åœ¨æ—¶ï¼‰
            if (elements.startBtn) elements.startBtn.addEventListener('click', startTimer);
            if (elements.pauseBtn) elements.pauseBtn.addEventListener('click', pauseTimer);
            if (elements.resetBtn) elements.resetBtn.addEventListener('click', resetTimer);
            if (elements.hoursInput) elements.hoursInput.addEventListener('change', handleGoalChange);
            if (elements.addRecordBtn) elements.addRecordBtn.addEventListener('click', addManualRecord);

            // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
            if (elements.dateInput) {
                const today = new Date().toISOString().split('T')[0];
                elements.dateInput.value = today;
            }

            // åˆå§‹åŒ–æ‰‹åŠ¨è¾“å…¥æ¡†é»˜è®¤å€¼
            if (elements.manualHoursInput) {
                elements.manualHoursInput.value = '1';
            }

            // åŠ è½½æœ¬åœ°å­˜å‚¨çš„è®°å½•
            loadFromLocalStorage();
            
            updateTimerDisplay();
            updateRemainingTime();
            updateEndTime();
            renderWorkRecords();
        }

        // ----------------------------------------------------
        // å·¥ä½œç›®æ ‡å˜æ›´å¤„ç†
        // ----------------------------------------------------
        function handleGoalChange() {
            const hoursInput = document.getElementById('timer-page-hours');
            updateRemainingTime();
        }

        // ----------------------------------------------------
        // å‰©ä½™æ—¶é—´è®¡ç®—ä¸æ›´æ–°
        // ----------------------------------------------------
        function updateRemainingTime() {
            const workHoursInput = document.getElementById('timer-page-hours');
                                
            if (!workHoursInput) return;
            
            const totalGoalHours = parseFloat(workHoursInput.value) || 0;
            workGoalTime = Math.round(totalGoalHours * 60 * 60); // è½¬æ¢ä¸ºç§’

            // è®¡ç®—å·²å®Œæˆçš„å·¥ä½œè®°å½•æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
            const completedHours = workRecords.reduce((total, record) => total + record.hours, 0);
            const completedTimeSec = Math.round(completedHours * 60 * 60);
            
            // åŸºç¡€å‰©ä½™æ—¶é—´ = ç›®æ ‡æ—¶é—´ - å·²å®Œæˆè®°å½•æ—¶é—´
            baseRemainingTime = Math.max(0, workGoalTime - completedTimeSec);
            
            // å¤„ç†è®¡æ—¶å™¨è¿è¡ŒçŠ¶æ€
            const wasRunning = isTimerRunning;
            if (wasRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
            }
            
            // åŒæ­¥å‰©ä½™æ—¶é—´
            remainingTime = baseRemainingTime;
            
            // é‡æ–°å¯åŠ¨è®¡æ—¶å™¨ï¼ˆå¦‚æœä¹‹å‰åœ¨è¿è¡Œï¼‰
            if (wasRunning) {
                startTimer();
            } else {
                updateTimerDisplay();
            }

            updateEndTime();
            saveToLocalStorage();
            updateTodayStats();
        }

        // ----------------------------------------------------
        // è®¡æ—¶å™¨æ§åˆ¶å‡½æ•° (æŒ‰ç…§ç”¨æˆ·è¦æ±‚çš„é€»è¾‘)
        // ----------------------------------------------------
        let totalSecondsWorked = 0;  // å˜é‡bï¼šè®¡æ—¶å™¨ç°åœ¨æ˜¾ç¤ºçš„æ—¶é—´ï¼ˆç§’ï¼‰
        let manualAddedSeconds = 0;  // ç”¨äºè®°å½•æ‰‹åŠ¨æ·»åŠ çš„æ—¶é—´ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
        
        function startTimer() {
            if (isTimerRunning) return;
            
            isTimerRunning = true;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const startBtn = document.getElementById('timer-page-start');
            const pauseBtn = document.getElementById('timer-page-pause');
            if (startBtn) startBtn.classList.add('hidden');
            if (pauseBtn) pauseBtn.classList.remove('hidden');
            
            // å¯åŠ¨è®¡æ—¶å™¨
            timerInterval = setInterval(function() {
                totalSecondsWorked++;
                updateTimerDisplay();
                updateEndTime(); // æ›´æ–°é¢„è®¡ä¸‹ç­æ—¶é—´
                saveToLocalStorage();
            }, 1000);
        }

        function pauseTimer() {
            if (!isTimerRunning) return;
            
            clearInterval(timerInterval);
            isTimerRunning = false;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const startBtn = document.getElementById('timer-page-start');
            const pauseBtn = document.getElementById('timer-page-pause');
            if (startBtn) startBtn.classList.remove('hidden');
            if (pauseBtn) pauseBtn.classList.add('hidden');
            
            saveToLocalStorage();
        }
        
        function resetTimer() {
            // åœæ­¢è®¡æ—¶å™¨
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                
                const startBtn = document.getElementById('timer-page-start');
                const pauseBtn = document.getElementById('timer-page-pause');
                if (startBtn) startBtn.classList.remove('hidden');
                if (pauseBtn) pauseBtn.classList.add('hidden');
            }
            
            // é‡ç½®è®¡æ—¶å™¨
            totalSecondsWorked = 0;
            
            // æ›´æ–°æ˜¾ç¤º
            updateTimerDisplay();
            updateRemainingTime();
            updateEndTime();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
            
            // æ¸…ç©ºä»Šå¤©çš„å·¥ä½œè®°å½•ï¼ˆä¿ç•™å…¶ä»–æ—¥æœŸçš„è®°å½•ï¼‰
            const today = new Date().toISOString().split('T')[0];
            workRecords = workRecords.filter(record => record.date !== today);
            
            // é‡æ–°æ¸²æŸ“å·¥ä½œè®°å½•
            renderWorkRecords();
            
            alert('ä»Šæ—¥å·¥ä½œè®¡æ—¶å·²é‡ç½®');
        }

        // ----------------------------------------------------
        // æ˜¾ç¤ºæ›´æ–°å‡½æ•° (é€‚åº”æ­£è®¡æ—¶)
        // ----------------------------------------------------
        function updateTimerDisplay() {
            let hours, minutes, seconds;
            if (isNaN(totalSecondsWorked) || totalSecondsWorked < 0) {
                hours = 0;
                minutes = 0;
                seconds = 0;
            } else {
                hours = Math.floor(totalSecondsWorked / 3600);
                minutes = Math.floor((totalSecondsWorked % 3600) / 60);
                seconds = totalSecondsWorked % 60;
            }
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ›´æ–°æ‰€æœ‰è®¡æ—¶å™¨æ˜¾ç¤ºå…ƒç´ 
            const countdownEl = document.getElementById('countdown');
            const timerDisplayEl = document.getElementById('timer-page-display');
            if (countdownEl) countdownEl.textContent = timeString;
            if (timerDisplayEl) timerDisplayEl.textContent = timeString;
        }

        function updateEndTime() {
            const workHoursInput = document.getElementById('timer-page-hours');
            if (!workHoursInput) return;
            
            const goalHours = parseFloat(workHoursInput.value) || 8; // é»˜è®¤8å°æ—¶
            const goalSeconds = goalHours * 3600;
            
            // è®¡ç®—é¢„è®¡ä¸‹ç­æ—¶é—´ d = e + a - b
            // e: å½“å‰æ—¶é—´ (now)
            // a: ç›®æ ‡æ—¶é—´ (goalSeconds) 
            // b: å½“å‰è®¡æ—¶å™¨æ˜¾ç¤ºæ—¶é—´ (totalSecondsWorked)
            const now = new Date();
            const remainingSeconds = Math.max(0, goalSeconds - totalSecondsWorked);
            const endTime = new Date(now.getTime() + remainingSeconds * 1000);
            
            const hours = endTime.getHours().toString().padStart(2, '0');
            const minutes = endTime.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            // æ›´æ–°æ‰€æœ‰ç»“æŸæ—¶é—´æ˜¾ç¤ºå…ƒç´ 
            const endTimeEl = document.getElementById('end-time');
            const timerPageEndTimeEl = document.getElementById('timer-page-end-time');
            if (endTimeEl) endTimeEl.textContent = timeString;
            if (timerPageEndTimeEl) timerPageEndTimeEl.textContent = timeString;
        }

        function updateTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayHours = workRecords
                .filter(record => record.date === today)
                .reduce((total, record) => total + record.hours, 0);
            
            const workHours = Math.floor(todayHours);
            const workMinutes = Math.round((todayHours - workHours) * 60);
            
            const todayWorkedEl = document.getElementById('today-worked');
            if (todayWorkedEl) {
                todayWorkedEl.textContent = `${workHours}å°æ—¶${workMinutes}åˆ†é’Ÿ`;
            }
        }

        // ----------------------------------------------------
        // å·¥ä½œè®°å½•ç®¡ç†
        // ----------------------------------------------------
        function addWorkRecord(hours, manual = false) {
            const now = new Date();
            const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const record = {
                date: dateString,
                time: timeString,
                hours: parseFloat(hours.toFixed(1)), // ä¿ç•™ä¸€ä½å°æ•°
                manual: manual
            };

            // å…ˆæ›´æ–°æœ¬åœ°è®°å½•å¹¶åˆ·æ–°UI
            workRecords.unshift({...record, id: Date.now()}); // ä¸´æ—¶ID
            renderWorkRecords();
            updateTodayStats();
            updateRemainingTime();
            saveToLocalStorage();

            // åŒæ­¥åˆ°åç«¯
            fetch('/api/work-records', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(record)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.record?.id) {
                    // ç”¨åç«¯è¿”å›çš„IDæ›¿æ¢ä¸´æ—¶ID
                    const index = workRecords.findIndex(r => 
                        r.date === data.record.date && r.time === data.record.time
                    );
                    if (index !== -1) {
                        workRecords[index] = data.record;
                        renderWorkRecords();
                        saveToLocalStorage();
                    }
                }
            })
            .catch(error => {
                console.error('æ·»åŠ å·¥ä½œè®°å½•åˆ°åç«¯å¤±è´¥:', error);
            });
        }

        function addManualRecord() {
            const hoursInput = document.getElementById('manual-hours');
            
            if (!hoursInput) return;
            
            const hours = parseFloat(hoursInput.value);
            
            if (isNaN(hours) || hours <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å·¥ä½œæ—¶é•¿ã€‚');
                return;
            }
            
            // å°†æ‰‹åŠ¨æ·»åŠ çš„æ—¶é—´ç›´æ¥åŠ åˆ°å½“å‰æ€»è®¡æ—¶å™¨æ—¶é—´ b = b + c
            const secondsToAdd = Math.round(hours * 3600);
            totalSecondsWorked += secondsToAdd;
            
            // æ›´æ–°æ˜¾ç¤º
            updateTimerDisplay();
            updateRemainingTime();
            updateEndTime();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
            
            alert(`å·²æ·»åŠ  ${hours} å°æ—¶çš„å·¥ä½œæ—¶é—´`);
            hoursInput.value = '1'; // é‡ç½®è¾“å…¥æ¡†
        }

        function deleteWorkRecord(id) {
            // å…ˆä»æœ¬åœ°ç§»é™¤å¹¶æ›´æ–°UI
            const recordIndex = workRecords.findIndex(record => record.id === id);
            if (recordIndex === -1) return;
            
            const deletedRecord = workRecords.splice(recordIndex, 1)[0];
            renderWorkRecords();
            updateTodayStats();
            updateRemainingTime();
            saveToLocalStorage();
            
            // åŒæ­¥åˆ°åç«¯ - ä½¿ç”¨åç«¯å®é™…çš„æ•´æ•°ID
            fetch(`/api/work-records/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æˆåŠŸåˆ é™¤ï¼Œä¿æŒè®°å½•åœ¨æœ¬åœ°åˆ é™¤çŠ¶æ€
                    console.log('å·¥ä½œè®°å½•åˆ é™¤æˆåŠŸ');
                } else {
                    // åˆ é™¤å¤±è´¥ï¼Œæ¢å¤è®°å½•
                    workRecords.splice(recordIndex, 0, deletedRecord);
                    renderWorkRecords();
                    updateTodayStats();
                    updateRemainingTime();
                    saveToLocalStorage();
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å·¥ä½œè®°å½•å¤±è´¥:', error);
                // å¦‚æœç½‘ç»œé”™è¯¯ï¼Œæ¢å¤åˆ é™¤çš„è®°å½•
                workRecords.splice(recordIndex, 0, deletedRecord);
                renderWorkRecords();
                updateTodayStats();
                updateRemainingTime();
                saveToLocalStorage();
                alert('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥');
            });
        }

        function renderWorkRecords() {
            const container = document.getElementById('work-records');
            if (!container) return;
            
            if (workRecords.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">æš‚æ— å·¥ä½œè®°å½•</div>';
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedRecords = [...workRecords].sort((a, b) => 
                new Date(b.date) - new Date(a.date) || 
                b.time.localeCompare(a.time)
            );

            container.innerHTML = '';
            
            sortedRecords.forEach(record => {
                const manualTag = record.manual 
                    ? '<span class="text-xs bg-blue-100 text-blue-800 rounded px-2 py-0.5 ml-2">æ‰‹åŠ¨</span>' 
                    : '';

                const recordElement = document.createElement('div');
                recordElement.className = 'border rounded-lg p-3 flex justify-between items-center mb-2';
                recordElement.innerHTML = `
                    <div>
                        <p class="font-medium">${record.date} ${record.time} ${manualTag}</p>
                        <p class="text-sm text-gray-500">å®Œæˆäº† ${record.hours} å°æ—¶çš„å·¥ä½œ</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700" onclick="deleteWorkRecord(${record.id})">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                container.appendChild(recordElement);
            });
        }

        // ----------------------------------------------------
        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        // ----------------------------------------------------
        function saveToLocalStorage() {
            try {
                localStorage.setItem('workRecords', JSON.stringify(workRecords));
                localStorage.setItem('timerState', JSON.stringify({
                    isRunning: isTimerRunning,
                    remainingTime: remainingTime,
                    baseRemainingTime: baseRemainingTime,
                    workGoalTime: workGoalTime
                }));
            } catch (e) {
                console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('workspaceData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // åŠ è½½å·¥ä½œè®°å½•
                    if (data.workRecords) {
                        workRecords = data.workRecords;
                    }
                    
                    // åŠ è½½è®¡æ—¶å™¨çŠ¶æ€
                    if (data.isTimerRunning !== undefined) {
                        isTimerRunning = data.isTimerRunning;
                    }
                    if (data.workGoalTime !== undefined) {
                        workGoalTime = data.workGoalTime;
                    }
                    if (data.remainingTime !== undefined) {
                        remainingTime = data.remainingTime;
                    }
                    
                    // å…³é”®ä¿®æ”¹ï¼šåªåœ¨åŒä¸€å¤©åŠ è½½ä¿å­˜çš„è®¡æ—¶å™¨æ—¶é—´ï¼Œæ–°ä¸€å¤©ä¿æŒä¸º0
                    const today = new Date().toISOString().split('T')[0];
                    const savedDate = localStorage.getItem('lastSavedDate');
                    
                    if (savedDate === today && data.totalSecondsWorked !== undefined) {
                        // åŒä¸€å¤©ï¼ŒåŠ è½½ä¹‹å‰ä¿å­˜çš„è®¡æ—¶å™¨æ—¶é—´ b
                        totalSecondsWorked = data.totalSecondsWorked;
                    } else {
                        // æ–°çš„ä¸€å¤©ï¼Œè®¡æ—¶å™¨é‡ç½®ä¸º0
                        totalSecondsWorked = 0;
                    }
                    
                    // æ¢å¤å·¥ä½œç›®æ ‡è¾“å…¥æ¡†å€¼
                    const hours = workGoalTime / 3600;
                    const hoursInput = document.getElementById('timer-page-hours');
                    if (hoursInput) hoursInput.value = hours;
                    
                    // å¦‚æœè®¡æ—¶å™¨ä¹‹å‰åœ¨è¿è¡Œï¼Œé‡æ–°å¯åŠ¨
                    if (isTimerRunning) {
                        startTimer();
                    }
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateTimerDisplay();
                    updateRemainingTime();
                    updateEndTime();
                    renderWorkRecords();
                } else {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œæ–°ä¸€å¤©è®¡æ—¶å™¨ä¸º0
                    const today = new Date().toISOString().split('T')[0];
                    totalSecondsWorked = 0;
                    updateTimerDisplay();
                    updateEndTime();
                }
            } catch (e) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥:', e);
                // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ–°ä¸€å¤©è®¡æ—¶å™¨ä¸º0
                const today = new Date().toISOString().split('T')[0];
                totalSecondsWorked = 0;
                updateTimerDisplay();
                updateEndTime();
            }
        }

        // ----------------------------------------------------
        // ä¹¦æ¶ã€PDFã€TXT é€»è¾‘
        // ----------------------------------------------------
        function initBooks() {
            // ç›‘å¬æ–‡ä»¶é€‰æ‹©ï¼Œæ˜¾ç¤ºç¼–ç é€‰é¡¹ï¼ˆä»…å¯¹TXTæ–‡ä»¶ï¼‰
            document.getElementById('pdf-file').addEventListener('change', function() {
                const file = this.files[0];
                if (file && file.name.toLowerCase().endsWith('.txt')) {
                    document.getElementById('txt-encoding-div').style.display = 'block';
                } else {
                    document.getElementById('txt-encoding-div').style.display = 'none';
                }
            });
            
            fetch('/api/get-pdfs') // å‡è®¾æ‚¨çš„ API èƒ½å¤Ÿè¿”å› PDF å’Œ TXT çš„åˆ—è¡¨
                .then(response => response.json())
                .then(data => {
                    if (data.books) {
                        pdfBooks = data.books;
                        renderBooks();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ä¹¦ç±å¤±è´¥:', error);
                    renderBooks();
                });
    
            document.getElementById('upload-pdf-btn').addEventListener('click', function() {
                document.getElementById('upload-modal').classList.remove('hidden');
                document.getElementById('pdf-title').focus();
            });
            
            document.getElementById('cancel-upload').addEventListener('click', function() {
                document.getElementById('upload-modal').classList.add('hidden');
                document.getElementById('pdf-upload-form').reset();
                document.getElementById('txt-encoding-div').style.display = 'none';
            });
            
            document.getElementById('pdf-upload-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('pdf-title').value.trim(); // ç¡®ä¿æ ‡é¢˜æ— å‰åç©ºæ ¼
                const fileInput = document.getElementById('pdf-file');
                const coverInput = document.getElementById('pdf-cover');
                
                if (!title || fileInput.files.length === 0) {
                    alert('è¯·è¾“å…¥æ ‡é¢˜å¹¶é€‰æ‹©æ–‡ä»¶ã€‚');
                    return;
                }

                const file = fileInput.files[0];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const fileType = (fileExtension === 'pdf' || fileExtension === 'txt') ? fileExtension : null;

                if (!fileType) {
                    alert('åªæ”¯æŒä¸Šä¼  .pdf æˆ– .txt æ–‡ä»¶ã€‚');
                    return;
                }
                
                const now = new Date();
                const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                
                let coverUrl = null;
                
                if (coverInput.files.length > 0) {
                     const reader = new FileReader();
                     reader.onload = (event) => {
                         coverUrl = event.target.result; 
                         finalizeUpload(file, title, dateString, coverUrl, fileType, this);
                     };
                     reader.readAsDataURL(coverInput.files[0]);
                     return;
                }
                
                finalizeUpload(file, title, dateString, coverUrl, fileType, this);
            });
            
            document.getElementById('close-pdf-reader').addEventListener('click', function() {
                document.getElementById('pdf-reader').classList.add('hidden');
                const shelfArea = document.querySelector('.book-shelf').parentElement;
                if (shelfArea) {
                    shelfArea.classList.remove('hidden');
                }
                
                pdfDoc = null;
            });

            document.getElementById('close-txt-reader').addEventListener('click', function() {
                document.getElementById('txt-reader-modal').classList.add('hidden');
                const shelfArea = document.querySelector('.book-shelf').parentElement;
                if (shelfArea) {
                    shelfArea.classList.remove('hidden');
                }
                // åœæ­¢ç›‘å¬é”®ç›˜äº‹ä»¶
                document.removeEventListener('keydown', window._txtKeydownHandler);
            });
            
            // æ·»åŠ é¡µé¢è·³è½¬åŠŸèƒ½
            document.getElementById('pdf-jump-btn').addEventListener('click', jumpToPdfPage);
            document.getElementById('txt-jump-btn').addEventListener('click', jumpToTxtPage);
            
            initTxtReader(); // åˆå§‹åŒ–TXTé˜…è¯»å™¨æ§åˆ¶
            
            renderBooks();
        }
        
        function jumpToPdfPage() {
            const input = document.getElementById('pdf-page-input');
            const pageNum = parseInt(input.value);
            if (pageNum && pdfDoc && pageNum >= 1 && pageNum <= pdfDoc.numPages) {
                currentPdfPage = pageNum;
                renderPage(pdfDoc, currentPdfPage);
                document.getElementById('pdf-page-info').textContent = `ç¬¬ ${currentPdfPage} é¡µ / å…± ${pdfDoc.numPages} é¡µ`;
                document.getElementById('pdf-container').parentElement.scrollTop = 0;
                input.value = '';
            }
        }
        
        // ç¡®ä¿renderPageå‡½æ•°æ˜¯å…¨å±€å¯è®¿é—®çš„ï¼Œä»¥ä¾¿jumpToPdfPageå¯ä»¥ä½¿ç”¨
        function renderPage(pdf, pageNum) {
            pdf.getPage(pageNum).then(page => {
                const containerWidth = document.getElementById('pdf-container').clientWidth;
                const viewport = page.getViewport({ scale: 1.5 });
                const scale = containerWidth / viewport.width;
                const finalViewport = page.getViewport({ scale: scale * 0.95 });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = finalViewport.height;
                canvas.width = finalViewport.width;
                
                canvas.className = 'shadow-lg border border-gray-200';
                
                const pdfContainer = document.getElementById('pdf-container');
                pdfContainer.innerHTML = '';
                pdfContainer.appendChild(canvas);
                
                page.render({ canvasContext: ctx, viewport: finalViewport });
            });
        }
        

        
        function jumpToTxtPage() {
            const input = document.getElementById('txt-page-input');
            const pageNum = parseInt(input.value);
            if (pageNum && pageNum >= 1) {
                const reader = document.getElementById('txt-reader');
                const pageHeight = reader.clientHeight;
                reader.scrollTop = pageHeight * (pageNum - 1);
                input.value = '';
            }
        }
        
        // index.html L1350 é™„è¿‘: finalizeUpload å‡½æ•°
        function finalizeUpload(file, title, dateString, coverUrl, fileType, formElement) {
            // ----------------------------------------------------
            // âœ… æ–°å¢ï¼šå‡†å¤‡ FormData å¯¹è±¡ç”¨äºå®é™…ä¸Šä¼ 
            // ----------------------------------------------------
            const formData = new FormData();
            formData.append('file', file); // åŸå§‹æ–‡ä»¶æ•°æ®
            formData.append('title', title); // ç”¨æˆ·è¾“å…¥çš„æ–‡æ¡£æ ‡é¢˜
            formData.append('file_type', fileType); // æ–‡ä»¶çš„ç±»å‹ (pdf/txt)

            // æ·»åŠ ç¼–ç ä¿¡æ¯
            if (fileType === 'txt') {
                const encoding = document.getElementById('file-encoding').value;
                formData.append('encoding', encoding);
            }

            // å¦‚æœæœ‰å°é¢å›¾ç‰‡ï¼Œä¹Ÿæ·»åŠ åˆ° FormData
            const coverInput = document.getElementById('pdf-cover');
            if (coverInput.files.length > 0) {
                formData.append('cover', coverInput.files[0]);
            }
            
            // ----------------------------------------------------
            // æ¨¡æ‹Ÿæ–‡ä»¶åï¼šä»…ç”¨äºå‰ç«¯åœ¨è¯·æ±‚æˆåŠŸåæ›´æ–° UI
            // ----------------------------------------------------
            const timestamp = Date.now() / 1000;
            const safeTitle = title.replace(/[^\w\s-]/g, '').trim().replace(/ /g, '_');
            const backendFileName = `${safeTitle}_${timestamp.toFixed(0)}.${fileType}`;
            
            const submitButton = formElement.querySelector('button[type="submit"]'); 
            const originalText = submitButton.innerHTML;
            
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-1"></i> ä¸Šä¼ ä¸­...';

            // ----------------------------------------------------
            // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ fetch API å‘é€æ–‡ä»¶åˆ°åç«¯
            // ----------------------------------------------------
            fetch('/api/upload-pdf', {
                method: 'POST',
                body: formData // ç›´æ¥å‘é€ FormData å¯¹è±¡ï¼Œä¸éœ€è¦è®¾ç½® Content-Type
            })
            .then(response => response.json())
            .then(data => {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;

                if (data.success) {
                    // åç«¯æˆåŠŸè¿”å›æ–°åˆ›å»ºçš„ä¹¦ç±ä¿¡æ¯ (åŒ…æ‹¬ id å’Œåç«¯ç”Ÿæˆçš„ file_path)
                    const newBook = {
                        id: data.book.id,
                        title: data.book.title, 
                        date: data.book.date,
                        file_path: data.book.file_path, // ä½¿ç”¨åç«¯è¿”å›çš„å®é™…æ–‡ä»¶å
                        file_type: data.book.file_type, 
                        cover_url: coverUrl,
                        scroll_pos: 0 
                    };
                    
                    pdfBooks.unshift(newBook);
                    renderBooks();
                    document.getElementById('upload-modal').classList.add('hidden');
                    formElement.reset();
                    document.getElementById('txt-encoding-div').style.display = 'none';
                    saveToLocalStorage();
                    alert(`æ–‡æ¡£ã€Š${newBook.title}ã€‹ä¸Šä¼ æˆåŠŸ!`);
                } else {
                    alert(`ä¸Šä¼ å¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                console.error('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œæˆ–æœåŠ¡å™¨è¿æ¥é”™è¯¯ã€‚');
            });
        }
        
        function renderBooks() {
            const shelf = document.getElementById('book-shelf');
            shelf.innerHTML = '';
            
            if (pdfBooks.length === 0) {
                 shelf.innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <i class="fa fa-book text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">ä¹¦æ¶æ˜¯ç©ºçš„ï¼Œè¯·ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€æœ¬ PDF æˆ– TXT æ–‡æ¡£ã€‚</p>
                    </div>
                `;
                return;
            }
            
            pdfBooks.forEach(book => {
                // å®‰å…¨åˆå§‹åŒ–ç¼ºå¤±å±æ€§
                book.file_type = book.file_type || (book.file_path && book.file_path.endsWith('.txt') ? 'txt' : 'pdf'); 
                book.scroll_pos = book.scroll_pos || 0;
                
                const bookElement = document.createElement('div');
                bookElement.className = 'book bg-white rounded-lg overflow-hidden card-shadow cursor-pointer relative';
                bookElement.setAttribute('data-id', book.id);
                
                const fileTypeDisplay = book.file_type ? book.file_type.toUpperCase() : 'PDF';

                let coverContent;
                if (book.cover_url) {
                    // ç”¨æˆ·ä¸Šä¼ äº†å°é¢å›¾
                    const imageClass = book.cover_url.includes('svg') ? 'book-cover h-48 w-full object-cover p-10' : 'book-cover h-48 w-full object-cover';
                    coverContent = `
                        <div class="h-48 bg-gray-200 flex items-center justify-center overflow-hidden">
                            <img src="${book.cover_url}" alt="${book.title} å°é¢" class="${imageClass}">
                        </div>
                    `;
                } else {
                    // ä½¿ç”¨æ–‡æ¡£æ ‡é¢˜ä½œä¸ºæ–‡å­—å°é¢
                    coverContent = `
                        <div class="h-48 bg-primary text-white p-4 flex items-center justify-center text-center font-bold text-lg leading-snug break-words" style="word-break: break-all;">
                            ${book.title}
                        </div>
                    `;
                }
                
                bookElement.innerHTML = `
                    <div class="absolute top-2 right-2 z-10">
                        <button class="delete-book bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition" 
                                data-id="${book.id}">
                            <i class="fa fa-times text-xs"></i>
                        </button>
                    </div>
                    ${coverContent}
                    <div class="p-3">
                        <h3 class="font-bold truncate">${book.title}</h3>
                        <p class="text-sm text-gray-500">ç±»å‹: ${fileTypeDisplay}</p>
                    </div>
                `;
                
                bookElement.addEventListener('click', function(e) {
                    if (e.target.closest('.delete-book')) {
                        return;
                    }
                    if (book.file_type === 'pdf') {
                        openPdfReader(book.id);
                    } else if (book.file_type === 'txt') {
                        openTxtReader(book.id);
                    }
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                bookElement.querySelector('.delete-book').addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ã€Š${book.title}ã€‹å—ï¼Ÿ`)) {
                        deleteBook(book.id);
                    }
                });
                
                shelf.appendChild(bookElement);
            });
        }

        function deleteBook(bookId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ–‡æ¡£å—ï¼Ÿ')) {
                // ä»åç«¯åˆ é™¤
                fetch(`/api/delete-pdf/${bookId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        pdfBooks = pdfBooks.filter(book => book.id !== bookId);
                        renderBooks();
                        saveToLocalStorage();
                        alert('æ–‡æ¡£åˆ é™¤æˆåŠŸï¼');
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }

        function openPdfReader(bookId) {
            const pdfContainer = document.getElementById('pdf-container');
            const pdfTitle = document.getElementById('pdf-viewer-title');
            const pdfReader = document.getElementById('pdf-reader');
            const prevBtn = document.getElementById('pdf-prev-page');
            const nextBtn = document.getElementById('pdf-next-page');
            const pageInfo = document.getElementById('pdf-page-info');
            const shelfArea = document.querySelector('.book-shelf').parentElement;
            const scrollContainer = pdfContainer.parentElement;

            pdfReader.classList.remove('hidden');
            shelfArea.classList.add('hidden');

            const book = pdfBooks.find(b => b.id === bookId);
            if (book) pdfTitle.textContent = book.title;
            
            pdfContainer.innerHTML = '<div class="text-center py-10"><i class="fa fa-spinner fa-spin text-4xl text-primary"></i><p class="mt-2">åŠ è½½PDFä¸­...</p></div>';
            
            // âœ… å…³é”®ä¿®æ­£ï¼šä½¿ç”¨ book.file_pathï¼Œå¹¶ç¡®ä¿ URL ç¼–ç 
            const pdfFileName = book ? book.file_path : 'error.pdf';
            const pdfFilePath = `/uploads/pdfs/${encodeURIComponent(pdfFileName)}`;

            fetch(pdfFilePath) 
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}. è¯·ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº /uploads/pdfs/ æ–‡ä»¶å¤¹ä¸­ã€‚`);
                    return response.blob();
                })
                .then(blob => {
                    if (blob.type !== 'application/pdf') throw new Error('è¿”å›çš„æ–‡ä»¶ä¸æ˜¯PDFæ ¼å¼ã€‚');
                    const url = URL.createObjectURL(blob);
                    
                    const loadingTask = pdfjsLib.getDocument(url);
                    loadingTask.promise.then(pdf => {
                        pdfContainer.innerHTML = '';
                        currentPdfPage = 1;
                        pdfDoc = pdf;
                        
                        renderPage(pdf, currentPdfPage);
                        pageInfo.textContent = `ç¬¬ ${currentPdfPage} é¡µ / å…± ${pdf.numPages} é¡µ`;
                        scrollContainer.scrollTop = 0;

                        prevBtn.onclick = null;
                        nextBtn.onclick = null;

                        const handlePrevPage = () => {
                            if (currentPdfPage > 1) {
                                currentPdfPage--;
                                renderPage(pdf, currentPdfPage);
                                pageInfo.textContent = `ç¬¬ ${currentPdfPage} é¡µ / å…± ${pdf.numPages} é¡µ`;
                                scrollContainer.scrollTop = 0;
                            }
                        };
                        
                        const handleNextPage = () => {
                            if (currentPdfPage < pdf.numPages) {
                                currentPdfPage++;
                                renderPage(pdf, currentPdfPage);
                                pageInfo.textContent = `ç¬¬ ${currentPdfPage} é¡µ / å…± ${pdf.numPages} é¡µ`;
                                scrollContainer.scrollTop = 0;
                            }
                        };

                        prevBtn.addEventListener('click', handlePrevPage);
                        nextBtn.addEventListener('click', handleNextPage);
                        
                        // æ·»åŠ é¡µé¢è·³è½¬åŠŸèƒ½åˆ°PDFé˜…è¯»å™¨
                        document.getElementById('pdf-jump-btn').addEventListener('click', () => {
                            jumpToPdfPage();
                        });
                        
                        function handleKeydown(e) {
                            if (!pdfReader.classList.contains('hidden')) {
                                // æ£€æŸ¥ç„¦ç‚¹æ˜¯å¦åœ¨å¤‡å¿˜å½•ç¼–è¾‘å™¨æˆ–å…¶ä»–å¯èƒ½éœ€è¦ç®­å¤´é”®çš„å…ƒç´ ä¸Š
                                const activeElement = document.activeElement;
                                if (activeElement && (activeElement.id === 'note-content-md' || 
                                                      activeElement.tagName === 'INPUT' || 
                                                      activeElement.tagName === 'TEXTAREA')) {
                                    return; // ä¸é˜»æ­¢ç®­å¤´é”®ï¼Œè®©å®ƒä»¬åœ¨ç¼–è¾‘å™¨ä¸­æ­£å¸¸ä½¿ç”¨
                                }
                                
                                switch(e.key) {
                                    case 'ArrowLeft':
                                        e.preventDefault();
                                        handlePrevPage();
                                        break;
                                    case 'ArrowRight':
                                        e.preventDefault();
                                        handleNextPage();
                                        break;
                                    case 'ArrowUp':
                                        e.preventDefault();
                                        pdfContainer.parentElement.scrollBy({ top: -100, behavior: 'smooth' });
                                        break;
                                    case 'ArrowDown':
                                        e.preventDefault();
                                        pdfContainer.parentElement.scrollBy({ top: 100, behavior: 'smooth' });
                                        break;
                                }
                            }
                        }
                        
                        document.removeEventListener('keydown', window._pdfKeydownHandler);
                        window._pdfKeydownHandler = handleKeydown;
                        document.addEventListener('keydown', window._pdfKeydownHandler);
                        
                        function renderPage(pdf, pageNum) {
                            pdf.getPage(pageNum).then(page => {
                                const containerWidth = pdfContainer.clientWidth;
                                const viewport = page.getViewport({ scale: 1.5 });
                                const scale = containerWidth / viewport.width;
                                const finalViewport = page.getViewport({ scale: scale * 0.95 });
                                
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.height = finalViewport.height;
                                canvas.width = finalViewport.width;
                                
                                canvas.className = 'shadow-lg border border-gray-200';
                                
                                pdfContainer.innerHTML = '';
                                pdfContainer.appendChild(canvas);
                                
                                page.render({ canvasContext: ctx, viewport: finalViewport });
                            });
                        }
                        
                    }).catch(error => {
                        pdfContainer.innerHTML = `<div class="text-center py-10 text-red-500"><i class="fa fa-exclamation-triangle text-4xl"></i><p class="mt-2">PDFè§£æå¤±è´¥: ${error.message}</p></div>`;
                    });
                })
                .catch(error => {
                    pdfContainer.innerHTML = `<div class="text-center py-10 text-red-500"><i class="fa fa-exclamation-triangle text-4xl"></i><p class="mt-2">æ–‡ä»¶åŠ è½½å¤±è´¥ (åç«¯è·¯å¾„: ${pdfFilePath}): ${error.message}</p></div>`;
                });
        }
        
        // TXT é˜…è¯»å™¨é€»è¾‘
        function openTxtReader(bookId) {
            const txtReaderModal = document.getElementById('txt-reader-modal');
            const txtTitle = document.getElementById('txt-viewer-title');
            const txtContent = document.getElementById('txt-content');
            const txtReader = document.getElementById('txt-reader');
            const shelfArea = document.querySelector('.book-shelf').parentElement;
            
            const book = pdfBooks.find(b => b.id === bookId);
            if (!book) return;

            currentTxtBookId = bookId; // è®¾ç½®å½“å‰é˜…è¯»çš„ä¹¦ç±ID
            txtTitle.textContent = book.title;
            txtReaderModal.classList.remove('hidden');
            shelfArea.classList.add('hidden');
            
            // åŠ è½½æ–‡æœ¬å†…å®¹
            const txtFilePath = `/uploads/pdfs/${encodeURIComponent(book.file_path)}`;
            txtContent.textContent = 'åŠ è½½ä¸­...';
            
            fetch(txtFilePath)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}. è¯·ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº /uploads/pdfs/ æ–‡ä»¶å¤¹ä¸­ã€‚`);
                    return response.text();
                })
                .then(text => {
                    txtContent.textContent = text;
                    
                    // æ¢å¤é˜…è¯»è¿›åº¦
                    txtReader.scrollTop = book.scroll_pos || 0;
                    updateTxtPageInfo();
                    
                    // æ¿€æ´»é”®ç›˜äº‹ä»¶
                    document.removeEventListener('keydown', window._txtKeydownHandler);
                    window._txtKeydownHandler = handleTxtKeydown;
                    document.addEventListener('keydown', window._txtKeydownHandler);
                })
                .catch(error => {
                    txtContent.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                    console.error('TXT åŠ è½½å¤±è´¥:', error);
                });
        }

        // ä¸ºç¼–ç é€‰æ‹©æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        document.getElementById('txt-display-encoding').addEventListener('change', function() {
            if (currentTxtBookId) {
                const book = pdfBooks.find(b => b.id === currentTxtBookId);
                if (book) {
                    reloadTxtWithEncoding(book, this.value);
                }
            }
        });

        // é‡æ–°åŠ è½½TXTæ–‡ä»¶å¹¶ä½¿ç”¨æŒ‡å®šç¼–ç 
        function reloadTxtWithEncoding(book, encoding) {
            const txtFilePath = `/uploads/pdfs/${encodeURIComponent(book.file_path)}`;
            const txtContent = document.getElementById('txt-content');
            
            txtContent.textContent = 'åŠ è½½ä¸­...';
            
            fetch(txtFilePath)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.arrayBuffer(); // è·å–åŸå§‹äºŒè¿›åˆ¶æ•°æ®
                })
                .then(buffer => {
                    // ä½¿ç”¨TextDecoderè§£ç æŒ‡å®šç¼–ç 
                    let decoder;
                    // å¤„ç†ä¸­æ–‡ç¼–ç 
                    if (encoding === 'gb2312') {
                        // GB2312ç¼–ç å¤„ç†ï¼Œå¯¹äºä¸æ”¯æŒçš„ç¼–ç å°è¯•ä½¿ç”¨GBK
                        try {
                            decoder = new TextDecoder(encoding);
                        } catch (e) {
                            // å¦‚æœä¸æ”¯æŒGB2312ï¼Œå°è¯•ä½¿ç”¨GBK
                            decoder = new TextDecoder('gbk');
                        }
                    } else {
                        // å…¶ä»–ç¼–ç ç›´æ¥ä½¿ç”¨æŒ‡å®šç¼–ç 
                        try {
                            decoder = new TextDecoder(encoding);
                        } catch (e) {
                            // å¦‚æœæŒ‡å®šç¼–ç ä¸æ”¯æŒï¼Œä½¿ç”¨UTF-8ä½œä¸ºé»˜è®¤ç¼–ç 
                            decoder = new TextDecoder('utf-8');
                        }
                    }
                    
                    const text = decoder.decode(buffer);
                    txtContent.textContent = text;
                })
                .catch(error => {
                    txtContent.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                    console.error('TXT åŠ è½½å¤±è´¥:', error);
                });
        }
        
        // åˆå§‹åŒ– TXT é˜…è¯»å™¨æ§åˆ¶ (ç»‘å®šäº‹ä»¶)
        function initTxtReader() {
            const txtReader = document.getElementById('txt-reader');
            const bgModeSelect = document.getElementById('bg-mode');
            const prevBtn = document.getElementById('txt-prev-page');
            const nextBtn = document.getElementById('txt-next-page');

            // ç›‘å¬èƒŒæ™¯åˆ‡æ¢
            bgModeSelect.addEventListener('change', function() {
                txtReader.classList.remove('bg-light-mode', 'bg-sepia-mode', 'bg-dark-mode');
                txtReader.classList.add(`bg-${this.value}`);
                
                // ç¡®ä¿ä¿å­˜è¿›åº¦ï¼Œå› ä¸ºèƒŒæ™¯å˜åŒ–å¯èƒ½å¯¼è‡´å†…å®¹é«˜åº¦å¾®è°ƒ
                saveTxtPosition(); 
                updateTxtPageInfo();
            });
            
            // åˆå§‹åŒ–èƒŒæ™¯æ¨¡å¼
            bgModeSelect.value = 'light-mode';
            txtReader.classList.add('bg-light-mode');

            // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œä¿å­˜è¿›åº¦
            txtReader.addEventListener('scroll', saveTxtPosition);
            txtReader.addEventListener('scroll', updateTxtPageInfo); // æ»šåŠ¨æ—¶æ›´æ–°é¡µç ä¿¡æ¯
            
            // ç»‘å®šç¿»é¡µæŒ‰é’®
            prevBtn.addEventListener('click', () => { scrollTxtPage(-1); });
            nextBtn.addEventListener('click', () => { scrollTxtPage(1); });
        }
        
        // é”®ç›˜ç¿»é¡µå¤„ç†
        function handleTxtKeydown(e) {
            if (!document.getElementById('txt-reader-modal').classList.contains('hidden')) {
                // æ£€æŸ¥ç„¦ç‚¹æ˜¯å¦åœ¨å¤‡å¿˜å½•ç¼–è¾‘å™¨æˆ–å…¶ä»–å¯èƒ½éœ€è¦ç®­å¤´é”®çš„å…ƒç´ ä¸Š
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.id === 'note-content-md' || 
                                      activeElement.tagName === 'INPUT' || 
                                      activeElement.tagName === 'TEXTAREA')) {
                    return; // ä¸é˜»æ­¢ç®­å¤´é”®ï¼Œè®©å®ƒä»¬åœ¨ç¼–è¾‘å™¨ä¸­æ­£å¸¸ä½¿ç”¨
                }
                
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        scrollTxtPage(-1);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        scrollTxtPage(1);
                        break;
                }
            }
        }

        // å®é™…çš„æ»šåŠ¨ç¿»é¡µé€»è¾‘
        function scrollTxtPage(direction) {
            const txtReader = document.getElementById('txt-reader');
            // æ»šåŠ¨é«˜åº¦ç­‰äºçª—å£é«˜åº¦ï¼Œå®ç°"ç¿»é¡µ"æ•ˆæœ
            const scrollHeight = txtReader.clientHeight; 

            txtReader.scrollBy({ top: scrollHeight * direction, behavior: 'smooth' });
            
            // ç¡®ä¿åœ¨æ»šåŠ¨ç»“æŸåæ›´æ–°é¡µç ä¿¡æ¯
            setTimeout(updateTxtPageInfo, 400); 
        }
        
        // ä¿å­˜é˜…è¯»ä½ç½®åˆ° localstorage
        function saveTxtPosition() {
            if (currentTxtBookId) {
                const book = pdfBooks.find(b => b.id === currentTxtBookId);
                if (book) {
                    book.scroll_pos = document.getElementById('txt-reader').scrollTop;
                    saveToLocalStorage();
                }
            }
        }
        
        // æ›´æ–°é¡µç ä¿¡æ¯ï¼ˆåŸºäºæ»šåŠ¨ä½ç½®çš„ç™¾åˆ†æ¯”ï¼‰
        function updateTxtPageInfo() {
            const txtReader = document.getElementById('txt-reader');
            const pageInfo = document.getElementById('txt-page-info');

            const scrollMax = txtReader.scrollHeight - txtReader.clientHeight;
            const scrollPercent = scrollMax > 0 ? (txtReader.scrollTop / scrollMax) : 0;
            
            // ç®€åŒ–é¡µæ•°è®¡ç®—ï¼šæ€»é«˜åº¦ / çª—å£é«˜åº¦ (å¦‚æœå†…å®¹æº¢å‡ºï¼Œåˆ™è‡³å°‘ä¸º 1)
            const totalPages = Math.max(1, Math.ceil(txtReader.scrollHeight / txtReader.clientHeight));
            
            // ä¼°è®¡å½“å‰é¡µç 
            let currentPage = 1;
            if (totalPages > 1) {
                // å°†æ»šåŠ¨ä½ç½®æ˜ å°„åˆ°é¡µç 
                currentPage = Math.min(totalPages, Math.floor(txtReader.scrollTop / (txtReader.clientHeight)) + 1);
            }

            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ (${(scrollPercent * 100).toFixed(0)}%)`;
        }

        // ----------------------------------------------------
        // ä¹¦ç­¾é€»è¾‘
        // ----------------------------------------------------
        // åˆå§‹åŒ–ä¹¦ç­¾æ—¶ä»åç«¯åŠ è½½
        function initBookmarks() {
            // å…ˆä»åç«¯è·å–ä¹¦ç­¾
            fetch('/api/bookmarks')
                .then(response => response.json())
                .then(data => {
                    if (data.bookmarks) {
                        bookmarks = data.bookmarks;
                        renderBookmarks();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ä¹¦ç­¾å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®:', error);
                    // å¤±è´¥æ—¶ fallback åˆ°æœ¬åœ°å­˜å‚¨
                    const localData = localStorage.getItem('workspaceData');
                    if (localData) {
                        bookmarks = JSON.parse(localData).bookmarks || [];
                        renderBookmarks();
                    }
                });

            document.getElementById('add-bookmark').addEventListener('click', addBookmark);
        }

        // æ·»åŠ ä¹¦ç­¾æ—¶åŒæ­¥åˆ°åç«¯
        function addBookmark() {
            const titleInput = document.getElementById('bookmark-title');
            const urlInput = document.getElementById('bookmark-url');
            
            const title = titleInput.value.trim();
            let url = urlInput.value.trim();
            
            if (!title || !url) {
                alert('æ ‡é¢˜å’Œç½‘å€ä¸èƒ½ä¸ºç©ºã€‚');
                return;
            }

            if (!/^https?:\/\//i.test(url)) {
                url = 'http://' + url;
            }

            // å‘é€åˆ°åç«¯
            fetch('/api/bookmarks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title, url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bookmarks.push(data.bookmark);
                    renderBookmarks();
                    saveToLocalStorage(); // åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
                    titleInput.value = '';
                    urlInput.value = '';
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('æ·»åŠ ä¹¦ç­¾å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œæ·»åŠ å¤±è´¥');
            });
        }

        // åˆ é™¤ä¹¦ç­¾æ—¶åŒæ­¥åˆ°åç«¯
        function deleteBookmark(id) {
            fetch(`/api/bookmarks/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bookmarks = bookmarks.filter(b => b.id !== id);
                    renderBookmarks();
                    saveToLocalStorage(); // åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤ä¹¦ç­¾å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥');
            });
        }
        
        function renderBookmarks() {
            const container = document.getElementById('bookmarks-list');
            container.innerHTML = '';
            
            if (bookmarks.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4 col-span-full">æš‚æ— ä¹¦ç­¾</div>';
                return;
            }
            
            bookmarks.forEach(b => {
                const item = document.createElement('div');
                item.className = 'bg-white border rounded-lg p-4 shadow flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <a href="${b.url}" target="_blank" class="font-bold text-primary hover:underline">${b.title}</a>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-3" onclick="deleteBookmark(${b.id})">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        // ----------------------------------------------------
        // éŸ³ä¹æ’­æ”¾å™¨é€»è¾‘
        // ----------------------------------------------------
        
        function initMusic() {
            const playlistIdInput = document.getElementById('netease-playlist-id');
            const orderSelect = document.getElementById('music-order'); 
            
            const savedPlaylistUrl = localStorage.getItem('neteasePlaylistUrl') || 'https://music.163.com/playlist?id=877029680'; 
            const savedOrder = localStorage.getItem('musicOrder') || 'list'; 
            
            // ä»ä¿å­˜çš„URLä¸­æå–ID
            const savedId = extractPlaylistId(savedPlaylistUrl) || '877029680';
            playlistIdInput.value = savedPlaylistUrl;  // æ˜¾ç¤ºå®Œæ•´URL
            orderSelect.value = savedOrder; 

            // å½“æ’­æ”¾æ¨¡å¼æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜å¹¶æ›´æ–°æ’­æ”¾å™¨
            orderSelect.addEventListener('change', function() {
                const currentUrl = playlistIdInput.value.trim();
                const playlistId = extractPlaylistId(currentUrl);
                
                if (playlistId) {
                    localStorage.setItem('neteasePlaylistUrl', currentUrl);
                    localStorage.setItem('musicOrder', this.value);
                    
                    renderMetingTag(playlistId, this.value);
                }
            });

            document.getElementById('save-music-setting').addEventListener('click', function() {
                const inputText = playlistIdInput.value.trim();
                
                // å°è¯•ä»è¾“å…¥ä¸­æå–ID
                let playlistId = extractPlaylistId(inputText);
                
                if (!playlistId) {
                    alert('æ— æ³•ä»è¾“å…¥ä¸­æå–åˆ°æœ‰æ•ˆçš„æ­Œå•IDï¼Œè¯·ç¡®ä¿è¾“å…¥çš„æ˜¯ç½‘æ˜“äº‘æ­Œå•é“¾æ¥');
                    return;
                }

                const order = orderSelect.value;
                
                localStorage.setItem('neteasePlaylistUrl', inputText);
                localStorage.setItem('musicOrder', order);
                
                renderMetingTag(playlistId, order);
                alert('æ­Œå•å’Œæ’­æ”¾æ¨¡å¼è®¾ç½®å·²ä¿å­˜ï¼Œå·²æ›´æ–°æ’­æ”¾å™¨');
            });
            
            // ä½¿ç”¨ä¿å­˜çš„URLåˆå§‹åŒ–æ’­æ”¾å™¨
            const initialPlaylistId = extractPlaylistId(savedPlaylistUrl);
            renderMetingTag(initialPlaylistId, savedOrder);
        }

        // ä»ç½‘æ˜“äº‘URLä¸­æå–æ­Œå•IDçš„å‡½æ•°
        function extractPlaylistId(url) {
            try {
                // å°è¯•è§£æURL
                const parsedUrl = new URL(url);
                // ä»URLå‚æ•°ä¸­è·å–id
                const id = parsedUrl.searchParams.get('id');
                if (id && /^\d+$/.test(id)) {
                    return id;
                }
            } catch (e) {
                // å¦‚æœURLæ ¼å¼ä¸æ­£ç¡®ï¼Œå°è¯•æ­£åˆ™åŒ¹é…
                const matches = url.match(/[?&]id=(\d+)/);
                if (matches && matches[1]) {
                    return matches[1];
                }
            }
            return null;
        }

        function renderMetingTag(playlistId, order = 'list') {
            const playerContainer = document.getElementById('music-player');
            if (!playerContainer) return;
            
            playerContainer.innerHTML = '';
            
            const metingTag = document.createElement('meting-js');
            metingTag.setAttribute('server', 'netease');
            metingTag.setAttribute('type', 'playlist');
            metingTag.setAttribute('id', playlistId);
            metingTag.setAttribute('fixed', 'false');
            metingTag.setAttribute('autoplay', 'false');
            metingTag.setAttribute('loop', 'all');
            metingTag.setAttribute('order', order);
            metingTag.setAttribute('preload', 'auto');
            metingTag.setAttribute('volume', '0.7');
            metingTag.setAttribute('theme', '#3B82F6');
            metingTag.setAttribute('list-folded', 'true');
            metingTag.setAttribute('list-max-height', '300px');
            metingTag.setAttribute('lrc-type', '3');
            
            playerContainer.appendChild(metingTag);
            
            // æ·»åŠ éŸ³ä¹æ’­æ”¾å™¨äº‹ä»¶å¤„ç† - ä½¿ç”¨æ›´å¯é çš„äº‹ä»¶ç›‘å¬
            setTimeout(() => {
                // ç­‰å¾…æ’­æ”¾å™¨åŠ è½½å®Œæˆ
                const checkAndSetupPlayer = () => {
                    const metingElements = document.querySelectorAll('meting-js');
                    if (metingElements.length > 0) {
                        const metingElement = metingElements[0];
                        
                        // ç­‰å¾…APlayerå®ä¾‹åˆ›å»ºå®Œæˆ
                        if (metingElement.aplayer) {
                            // ä¸Šä¸€é¦–
                            document.getElementById('music-prev')?.addEventListener('click', function() {
                                metingElement.aplayer.skipBack();
                            });
                            
                            // ä¸‹ä¸€é¦–
                            document.getElementById('music-next')?.addEventListener('click', function() {
                                metingElement.aplayer.skipForward();
                            });
                            
                            // æ’­æ”¾/æš‚åœ
                            const playPauseBtn = document.getElementById('music-play-pause');
                            if (playPauseBtn) {
                                playPauseBtn.addEventListener('click', function() {
                                    if (metingElement.aplayer.audio.paused) {
                                        metingElement.aplayer.play();
                                        const iconElement = document.getElementById('play-pause-icon');
                                        if (iconElement) iconElement.className = 'fa fa-pause';
                                    } else {
                                        metingElement.aplayer.pause();
                                        const iconElement = document.getElementById('play-pause-icon');
                                        if (iconElement) iconElement.className = 'fa fa-play';
                                    }
                                });
                            }
                            
                            // ç›‘å¬æ’­æ”¾çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®å›¾æ ‡
                            metingElement.aplayer.on('play', function() {
                                const iconElement = document.getElementById('play-pause-icon');
                                if (iconElement) iconElement.className = 'fa fa-pause';
                            });
                            
                            metingElement.aplayer.on('pause', function() {
                                const iconElement = document.getElementById('play-pause-icon');
                                if (iconElement) iconElement.className = 'fa fa-play';
                            });
                        } else {
                            // å¦‚æœæ’­æ”¾å™¨è¿˜æ²¡å‡†å¤‡å¥½ï¼Œç¨åå†è¯•
                            setTimeout(checkAndSetupPlayer, 500);
                        }
                    } else {
                        // å¦‚æœmetingå…ƒç´ è¿˜æ²¡åŠ è½½å®Œæˆï¼Œç¨åå†è¯•
                        setTimeout(checkAndSetupPlayer, 500);
                    }
                };
                
                // å¼€å§‹æ£€æŸ¥æ’­æ”¾å™¨
                checkAndSetupPlayer();
            }, 2000); // å»¶è¿Ÿ2ç§’ç¡®ä¿æ’­æ”¾å™¨å®Œå…¨åŠ è½½
        }
        
        // ----------------------------------------------------
        // æ¸¸æˆé€»è¾‘
        // ----------------------------------------------------
        function initGames() {
            const gameSelectors = document.querySelectorAll('.game-selector');
            gameSelectors.forEach(selector => {
                selector.addEventListener('click', function() {
                    gameSelectors.forEach(s => {
                        s.classList.remove('active', 'bg-primary', 'text-white');
                        s.classList.add('bg-gray-200', 'hover:bg-gray-300');
                    });
                    this.classList.add('active', 'bg-primary', 'text-white');
                    this.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                    
                    const gameId = this.getAttribute('data-game');
                    document.querySelectorAll('.game-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(gameId).classList.remove('hidden');
                });
            });
            
            document.getElementById('upload-game-btn').addEventListener('click', function() {
                gameSelectors.forEach(s => {
                    s.classList.remove('active', 'bg-primary', 'text-white');
                    s.classList.add('bg-gray-200', 'hover:bg-gray-300');
                });
                this.classList.add('active', 'bg-primary', 'text-white');
                this.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                
                document.querySelectorAll('.game-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById('game-upload').classList.remove('hidden');
                
                // åŠ è½½è‡ªå®šä¹‰æ¸¸æˆåˆ—è¡¨
                loadCustomGames();
            });
            
            initGame1024();
            // initMinesweeper(); // ç§»é™¤ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨ç”¨iframeåŠ è½½æ‰«é›·æ¸¸æˆ
            
            // ä¸Šä¼ è‡ªå®šä¹‰æ¸¸æˆ
            document.getElementById('upload-game-submit').addEventListener('click', uploadCustomGame);
        }
        
        function uploadCustomGame() {
            const nameInput = document.getElementById('game-name');
            const fileInput = document.getElementById('game-file');
            
            const name = nameInput.value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥æ¸¸æˆåç§°');
                return;
            }
            
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©æ¸¸æˆæ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            const allowedExtensions = ['.html', '.htm', '.js', '.zip'];
            const fileExt = file.name.toLowerCase().split('.').pop();
            if (!allowedExtensions.some(ext => `.${fileExt}` === ext)) {
                alert('åªæ”¯æŒä¸Šä¼ HTMLã€HTMã€JSæˆ–ZIPæ ¼å¼çš„æ¸¸æˆæ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            
            fetch('/api/upload-game', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ¸¸æˆä¸Šä¼ æˆåŠŸï¼');
                    nameInput.value = '';
                    fileInput.value = '';
                    loadCustomGames();
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        function loadCustomGames() {
            fetch('/api/get-games')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('custom-games-container');
                container.innerHTML = '';
                
                if (data.games.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-center py-4 col-span-full">æš‚æ— è‡ªå®šä¹‰æ¸¸æˆ</div>';
                    return;
                }
                
                data.games.forEach(game => {
                    const gameItem = document.createElement('div');
                    gameItem.className = 'bg-white border rounded-lg p-4 shadow flex justify-between items-center';
                    gameItem.innerHTML = `
                        <div class="flex-1">
                            <div class="font-bold">${game.name}</div>
                            <div class="text-xs text-gray-500">${game.upload_date}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-primary hover:text-blue-700" onclick="playCustomGame(${game.id})">
                                <i class="fa fa-play"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteCustomGame(${game.id})">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(gameItem);
                });
            })
            .catch(error => {
                console.error('åŠ è½½è‡ªå®šä¹‰æ¸¸æˆå¤±è´¥:', error);
            });
        }
        
        function playCustomGame(gameId) {
            // å¯ä»¥åœ¨æ–°çª—å£æ‰“å¼€æ¸¸æˆæ–‡ä»¶
            window.open(`/uploads/games/${gameId}`, '_blank');
        }
        
        function deleteCustomGame(gameId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰æ¸¸æˆå—ï¼Ÿ')) {
                fetch(`/api/delete-game/${gameId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æ¸¸æˆåˆ é™¤æˆåŠŸï¼');
                        loadCustomGames();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤æ¸¸æˆå¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }
        
        function initGame1024() {
            const gridSize = 4;
            let grid = [];
            let score = 0;
            const gridElement = document.getElementById('grid-1024');
            
            function setGridSize() {
                const containerWidth = gridElement.parentElement.clientWidth;
                const cellSize = Math.floor((containerWidth - 30) / gridSize);
                gridElement.style.gridTemplateColumns = `repeat(${gridSize}, ${cellSize}px)`;
            }
            
            function initializeGrid() {
                grid = Array(gridSize).fill().map(() => Array(gridSize).fill(0));
                score = 0;
                addNewTile();
                addNewTile();
                renderGrid();
                updateScore();
                setGridSize();
            }
            
            function addNewTile() {
                const emptyTiles = [];
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        if (grid[i][j] === 0) {
                            emptyTiles.push({i, j});
                        }
                    }
                }
                if (emptyTiles.length > 0) {
                    const {i, j} = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
                    grid[i][j] = Math.random() < 0.9 ? 2 : 4;
                }
            }
            
            function renderGrid() {
                gridElement.innerHTML = '';
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        const value = grid[i][j];
                        const cell = document.createElement('div');
                        cell.className = `cell rounded-lg ${getTileClass(value)}`;
                        cell.textContent = value !== 0 ? value : '';
                        gridElement.appendChild(cell);
                    }
                }
            }
            
            function getTileClass(value) {
                const classes = {
                    0: 'bg-gray-100 border-gray-200',
                    2: 'bg-amber-50 text-amber-900 font-bold text-3xl',
                    4: 'bg-amber-100 text-amber-900 font-bold text-3xl',
                    8: 'bg-orange-100 text-orange-900 font-bold text-3xl',
                    16: 'bg-orange-200 text-orange-900 font-bold text-3xl',
                    32: 'bg-orange-300 text-orange-900 font-bold text-3xl',
                    64: 'bg-orange-400 text-orange-900 font-bold text-3xl',
                    128: 'bg-yellow-200 text-yellow-900 font-bold text-4xl',
                    256: 'bg-yellow-300 text-yellow-900 font-bold text-4xl',
                    512: 'bg-yellow-400 text-white font-bold text-4xl',
                    1024: 'bg-yellow-500 text-white font-bold text-5xl',
                    2048: 'bg-yellow-600 text-white font-bold text-5xl'
                };
                return classes[value] || 'bg-red-500 text-white text-2xl';
            }
            
            function updateScore() {
                document.getElementById('score-1024').textContent = score;
            }
            
            function move(direction) {
                let moved = false;
                let merged = Array(gridSize).fill().map(() => Array(gridSize).fill(false));
                
                switch(direction) {
                    case 'up':
                        for (let j = 0; j < gridSize; j++) {
                            for (let i = 1; i < gridSize; i++) {
                                if (grid[i][j] !== 0) {
                                    let row = i;
                                    while (row > 0 && grid[row - 1][j] === 0) {
                                        grid[row - 1][j] = grid[row][j];
                                        grid[row][j] = 0;
                                        row--;
                                        moved = true;
                                    }
                                    if (row > 0 && grid[row - 1][j] === grid[row][j] && !merged[row - 1][j]) {
                                        grid[row - 1][j] *= 2;
                                        score += grid[row - 1][j];
                                        grid[row][j] = 0;
                                        merged[row - 1][j] = true;
                                        moved = true;
                                    }
                                }
                            }
                        }
                        break;
                    case 'down':
                        for (let j = 0; j < gridSize; j++) {
                            for (let i = gridSize - 2; i >= 0; i--) {
                                if (grid[i][j] !== 0) {
                                    let row = i;
                                    while (row < gridSize - 1 && grid[row + 1][j] === 0) {
                                        grid[row + 1][j] = grid[row][j];
                                        grid[row][j] = 0;
                                        row++;
                                        moved = true;
                                    }
                                    if (row < gridSize - 1 && grid[row + 1][j] === grid[row][j] && !merged[row + 1][j]) {
                                        grid[row + 1][j] *= 2;
                                        score += grid[row + 1][j];
                                        grid[row][j] = 0;
                                        merged[row + 1][j] = true;
                                        moved = true;
                                    }
                                }
                            }
                        }
                        break;
                    case 'left':
                        for (let i = 0; i < gridSize; i++) {
                            for (let j = 1; j < gridSize; j++) {
                                if (grid[i][j] !== 0) {
                                    let col = j;
                                    while (col > 0 && grid[i][col - 1] === 0) {
                                        grid[i][col - 1] = grid[i][col];
                                        grid[i][col] = 0;
                                        col--;
                                        moved = true;
                                    }
                                    if (col > 0 && grid[i][col - 1] === grid[i][col] && !merged[i][col - 1]) {
                                        grid[i][col - 1] *= 2;
                                        score += grid[i][col - 1];
                                        grid[i][col] = 0;
                                        merged[i][col - 1] = true;
                                        moved = true;
                                    }
                                }
                            }
                        }
                        break;
                    case 'right':
                        for (let i = 0; i < gridSize; i++) {
                            for (let j = gridSize - 2; j >= 0; j--) {
                                if (grid[i][j] !== 0) {
                                    let col = j;
                                    while (col < gridSize - 1 && grid[i][col + 1] === 0) {
                                        grid[i][col + 1] = grid[i][col];
                                        grid[i][col] = 0;
                                        col++;
                                        moved = true;
                                    }
                                    if (col < gridSize - 1 && grid[i][col + 1] === grid[i][col] && !merged[i][col + 1]) {
                                        grid[i][col + 1] *= 2;
                                        score += grid[i][col + 1];
                                        grid[i][col] = 0;
                                        merged[i][col + 1] = true;
                                        moved = true;
                                    }
                                }
                            }
                        }
                        break;
                }
                if (moved) {
                    addNewTile();
                    renderGrid();
                    updateScore();
                    if (isGameOver()) {
                        setTimeout(() => {
                            alert(`æ¸¸æˆç»“æŸï¼æ‚¨çš„å¾—åˆ†æ˜¯: ${score}`);
                        }, 500);
                    }
                }
            }
            
            function isGameOver() {
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        if (grid[i][j] === 0) {
                            return false;
                        }
                    }
                }
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        if ((i < gridSize - 1 && grid[i][j] === grid[i + 1][j]) ||
                            (j < gridSize - 1 && grid[i][j] === grid[i][j + 1])) {
                            return false;
                        }
                    }
                }
                return true;
            }
            
            document.addEventListener('keydown', function(e) {
                // åªæœ‰å½“1024æ¸¸æˆé¡µé¢æ˜¯æ´»åŠ¨çŠ¶æ€æ—¶æ‰æ‹¦æˆªç®­å¤´é”®
                if (document.getElementById('game-1024').classList.contains('hidden')) {
                    return;
                }
                
                // æ£€æŸ¥ç„¦ç‚¹æ˜¯å¦åœ¨å¤‡å¿˜å½•ç¼–è¾‘å™¨æˆ–å…¶ä»–å¯èƒ½éœ€è¦ç®­å¤´é”®çš„å…ƒç´ ä¸Š
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.id === 'note-content-md' || 
                                      activeElement.tagName === 'INPUT' || 
                                      activeElement.tagName === 'TEXTAREA')) {
                    return; // ä¸é˜»æ­¢ç®­å¤´é”®ï¼Œè®©å®ƒä»¬åœ¨ç¼–è¾‘å™¨ä¸­æ­£å¸¸ä½¿ç”¨
                }
                
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        move('up');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        move('down');
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        move('left');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        move('right');
                        break;
                }
            });
            
            window.addEventListener('resize', setGridSize);
            document.getElementById('restart-1024').addEventListener('click', initializeGrid);
            initializeGrid();
        }
        

        
        // ----------------------------------------------------
        // å¤‡å¿˜å½•é€»è¾‘
        // ----------------------------------------------------
        function initNotes() {
            // ä»åç«¯åŠ è½½å¤‡å¿˜å½•
            fetch('/api/notes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        notes = data.notes;  // ç”¨åç«¯æ•°æ®è¦†ç›–æœ¬åœ°æ•°æ®
                        renderNotes();
                        updateTodayStats();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å¤‡å¿˜å½•å¤±è´¥:', error);
                    // å¤±è´¥æ—¶ fallback åˆ°æœ¬åœ°å­˜å‚¨
                    const localData = localStorage.getItem('workspaceData');
                    if (localData) {
                        notes = JSON.parse(localData).notes || [];
                        renderNotes();
                    }
                });

            document.getElementById('create-note-btn').addEventListener('click', function() {
                currentNoteId = null;
                document.getElementById('note-title').value = '';
                document.getElementById('note-content-md').value = '';
                document.getElementById('notes-list').classList.add('hidden');
                document.getElementById('note-editor').classList.remove('hidden');
                document.getElementById('note-title').focus();
                document.getElementById('delete-note-btn').classList.add('hidden');
                
                // æ¸…ç©ºé¢„è§ˆåŒºåŸŸ
                document.getElementById('note-preview').innerHTML = '<div class="prose max-w-none">åœ¨æ­¤è¾“å…¥ Markdown å†…å®¹ä»¥é¢„è§ˆ...</div>';
            });
            
            document.getElementById('close-note-btn').addEventListener('click', function() {
                document.getElementById('note-editor').classList.add('hidden');
                document.getElementById('notes-list').classList.remove('hidden');
            });
            
            document.getElementById('delete-note-btn').addEventListener('click', function() {
                if (currentNoteId && confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡å¤‡å¿˜å½•å—ï¼Ÿ')) {
                    // è°ƒç”¨åç«¯åˆ é™¤æ¥å£
                    fetch(`/api/notes/${currentNoteId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                notes = notes.filter(note => note.id !== currentNoteId);
                                renderNotes();
                                document.getElementById('note-editor').classList.add('hidden');
                                document.getElementById('notes-list').classList.remove('hidden');
                                updateTodayStats();
                            } else {
                                alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                            }
                        })
                        .catch(error => {
                            console.error('åˆ é™¤å¤±è´¥:', error);
                            alert('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥');
                        });
                }
            });
                        
            document.getElementById('save-note-btn').addEventListener('click', saveNote);
            

            

            
            // å¤‡å¿˜å½•å†…å®¹å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜
            document.getElementById('note-content-md').addEventListener('input', function() {
                if (currentNoteId) {
                    // è‡ªåŠ¨ä¿å­˜ï¼Œæ¯1ç§’æœ€å¤šä¿å­˜ä¸€æ¬¡
                    clearTimeout(window.noteAutoSaveTimer);
                    window.noteAutoSaveTimer = setTimeout(() => {
                        saveNote();
                    }, 1000);
                }
                // å®æ—¶é¢„è§ˆ
                renderMarkdownPreview(this.value);
            });
            
            // æ·»åŠ ç®­å¤´é”®å¯¼èˆªåŠŸèƒ½
            document.getElementById('note-content-md').addEventListener('keydown', function(e) {
                // å¤„ç†ç®­å¤´é”®ï¼Œä½†ä¸å½±å“å…¶ä»–åŠŸèƒ½
                // è¿™äº›é”®åœ¨textareaä¸­é»˜è®¤å…·æœ‰å…‰æ ‡ç§»åŠ¨åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç‰¹åˆ«å¤„ç†
                // ä½†å¯ä»¥æ·»åŠ ä¸€äº›å¢å¼ºåŠŸèƒ½ï¼Œæ¯”å¦‚Tabé”®ç¼©è¿›
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    
                    // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ä¸¤ä¸ªç©ºæ ¼ä½œä¸ºç¼©è¿›
                    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                    
                    // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥çš„ç©ºæ ¼ä¹‹å
                    this.selectionStart = this.selectionEnd = start + 2;
                }
            });
            
            // æ ‡é¢˜å˜åŒ–æ—¶æ›´æ–°ï¼Œå¦‚æœå½“å‰æ²¡æœ‰æ ‡é¢˜åˆ™ä½¿ç”¨å†…å®¹å‰å‡ ä¸ªå­—
            document.getElementById('note-title').addEventListener('input', function() {
                if (!currentNoteId && this.value === '') {
                    const content = document.getElementById('note-content-md').value.substring(0, 5).trim();
                    if (content) {
                        this.value = content;
                    }
                }
            });
            
            // ä¸ºé¢„è§ˆæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œéœ€è¦æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const previewBtn = document.getElementById('preview-note-btn');
            if (previewBtn) {
                previewBtn.addEventListener('click', function() {
                    const content = document.getElementById('note-content-md')?.value;
                    if (content) {
                        renderMarkdownPreview(content);
                    }
                });
            }
            
            const saveBtn = document.getElementById('save-note-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    saveNote();
                });
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (!document.getElementById('note-editor').classList.contains('hidden')) {
                        saveNote();
                    }
                }
            });
            
            renderNotes();
        }
        
        function saveNote() {
            const titleEl = document.getElementById('note-title');
            const contentEl = document.getElementById('note-content-md');
            
            let title = titleEl.value.trim();
            const content = contentEl.value.trim();
            
            // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œä½¿ç”¨å†…å®¹çš„å‰5ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜
            if (!title) {
                const plainText = content.substring(0, 5);
                title = plainText || 'æœªå‘½åå¤‡å¿˜å½•';
                titleEl.value = title;
            }

            const noteData = { title, content };
            const saveButton = document.getElementById('save-note-btn');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-1"></i> ä¿å­˜ä¸­...';
            saveButton.disabled = true;

            if (currentNoteId) {
                // æ›´æ–°å·²æœ‰å¤‡å¿˜å½•ï¼ˆè°ƒç”¨PUTæ¥å£ï¼‰
                fetch(`/api/notes/${currentNoteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(noteData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const index = notes.findIndex(n => n.id === currentNoteId);
                        if (index !== -1) notes[index] = data.note;
                        renderNotes();
                        updateTodayStats();
                        showSaveSuccess(saveButton, originalText);
                    } else {
                        throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
                    }
                })
                .catch(error => handleSaveError(error, saveButton, originalText));
            } else {
                // åˆ›å»ºæ–°å¤‡å¿˜å½•ï¼ˆè°ƒç”¨POSTæ¥å£ï¼‰
                fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(noteData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        notes.unshift(data.note);
                        currentNoteId = data.note.id;
                        renderNotes();
                        updateTodayStats();
                        document.getElementById('delete-note-btn').classList.remove('hidden');
                        showSaveSuccess(saveButton, originalText);
                    } else {
                        throw new Error(data.error || 'åˆ›å»ºå¤±è´¥');
                    }
                })
                .catch(error => handleSaveError(error, saveButton, originalText));
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºä¿å­˜æˆåŠŸçŠ¶æ€
        function showSaveSuccess(button, originalText) {
            button.innerHTML = '<i class="fa fa-check mr-1"></i> å·²ä¿å­˜';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }

        // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†ä¿å­˜é”™è¯¯
        function handleSaveError(error, button, originalText) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            button.innerHTML = '<i class="fa fa-exclamation mr-1"></i> ä¿å­˜å¤±è´¥';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
        
        // Markdown ç¼–è¾‘è¾…åŠ©å‡½æ•°
        function insertMarkdownSyntax(before, after, placeholder) {
            const textarea = document.getElementById('note-content-md');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            const textToInsert = selectedText || placeholder;
            const newText = textarea.value.substring(0, start) + before + textToInsert + after + textarea.value.substring(end);
            
            textarea.value = newText;
            textarea.selectionStart = start + before.length;
            textarea.selectionEnd = start + before.length + textToInsert.length;
            textarea.focus();
            
            // è§¦å‘inputäº‹ä»¶ä»¥æ›´æ–°é¢„è§ˆ
            textarea.dispatchEvent(new Event('input'));
        }
        
        function insertAtCursor(elementId, text) {
            const element = document.getElementById(elementId);
            const start = element.selectionStart;
            const end = element.selectionEnd;
            const before = element.value.substring(0, start);
            const after = element.value.substring(end);
            
            element.value = before + text + after;
            element.selectionStart = element.selectionEnd = start + text.length;
            element.focus();
            
            // è§¦å‘inputäº‹ä»¶ä»¥æ›´æ–°é¢„è§ˆ
            element.dispatchEvent(new Event('input'));
        }
        
        function renderMarkdownPreview(content) {
            // ä½¿ç”¨marked.jsè¿›è¡Œæ¸²æŸ“
            if (typeof marked !== 'undefined') {
                const html = marked.parse(content);
                document.getElementById('note-preview').innerHTML = `<div class="prose max-w-none">${html}</div>`;
            } else {
                // å¦‚æœmarked.jsä¸å¯ç”¨ï¼Œç®€å•æ˜¾ç¤ºè½¬æ¢
                document.getElementById('note-preview').innerHTML = `<div class="prose max-w-none">${content}</div>`;
            }
        }
        
        function renderNotes() {
            const container = document.getElementById('notes-list');
            container.innerHTML = '';
            
            if (notes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <i class="fa fa-sticky-note text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">æš‚æ— å¤‡å¿˜å½•</p>
                        <button id="create-first-note" class="mt-3 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition">
                            åˆ›å»ºç¬¬ä¸€æ¡å¤‡å¿˜å½•
                        </button>
                    </div>
                `;
                document.getElementById('create-first-note').addEventListener('click', function() {
                    document.getElementById('create-note-btn').click();
                });
                return;
            }
            
            notes.forEach(note => {
                // å¯¹äºMarkdownå†…å®¹ï¼Œæ˜¾ç¤ºå‰100ä¸ªå­—ç¬¦
                const plainText = note.content.substring(0, 100);
                
                const noteElement = document.createElement('div');
                noteElement.className = 'note-card bg-white border border-gray-200 rounded-lg overflow-hidden card-shadow cursor-pointer';
                noteElement.setAttribute('data-id', note.id);
                noteElement.innerHTML = `
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-2 truncate">${note.title}</h3>
                        <p class="text-gray-600 text-sm line-clamp-3 mb-3">${plainText}${note.content.length > 100 ? '...' : ''}</p>
                        <p class="text-xs text-gray-400">æœ€åç¼–è¾‘ï¼š${note.last_edited}</p>
                    </div>
                `;
                
                // ä¿®æ”¹ç‚¹å‡»äº‹ä»¶ä»¥é€‚åº”Markdownç¼–è¾‘å™¨
                noteElement.addEventListener('click', function() {
                    const noteId = this.getAttribute('data-id');
                    const note = notes.find(n => n.id === noteId); // å­—ç¬¦ä¸²æ¯”è¾ƒ
                    
                    if (note) {
                        currentNoteId = noteId; // ä¿æŒIDä¸ºå­—ç¬¦ä¸²ç±»å‹
                        const titleInput = document.getElementById('note-title');
                        const contentMdEl = document.getElementById('note-content-md');
                        const previewEl = document.getElementById('note-preview');
                        const notesList = document.getElementById('notes-list');
                        const noteEditor = document.getElementById('note-editor');
                        const deleteBtn = document.getElementById('delete-note-btn');
                        
                        // å†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…ç©ºå¼•ç”¨
                        if (titleInput && contentMdEl && previewEl && notesList && noteEditor && deleteBtn) {
                            titleInput.value = note.title;
                            contentMdEl.value = note.content;
                            renderMarkdownPreview(note.content); // æ¸²æŸ“Markdowné¢„è§ˆ
                            notesList.classList.add('hidden');
                            noteEditor.classList.remove('hidden');
                            deleteBtn.classList.remove('hidden');
                        } else {
                            console.error('å¤‡å¿˜å½•ç¼–è¾‘æ‰€éœ€çš„DOMå…ƒç´ ä¸å­˜åœ¨');
                        }
                    }
                });
                container.appendChild(noteElement);
            });
        }

        // å…¨å±€å˜é‡ - å½“å‰æ´»è·ƒå¯¹è¯ID
        let currentConversationId = null;

        // åˆå§‹åŒ–å¯¹è¯åŠŸèƒ½ï¼ˆæ‰©å±•åŸinitChatå‡½æ•°ï¼‰
        function initChat() {
            // åŠ è½½AIé…ç½®
            fetch('/api/ai-config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.config) {
                        document.getElementById('qwen-api-key').value = data.config.api_key;
                        document.getElementById('model-type').value = data.config.model_type;
                    }
                })
                .catch(() => console.log('æœªæ‰¾åˆ°AIé…ç½®'));
            
            document.getElementById('save-api-key').addEventListener('click', function() {
                const apiKey = document.getElementById('qwen-api-key').value;
                const modelType = document.getElementById('model-type').value;
                
                if (!apiKey) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„APIå¯†é’¥');
                    return;
                }
                
                fetch('/api/ai-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({api_key: apiKey, model_type: modelType})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('APIå¯†é’¥å’Œæ¨¡å‹ç±»å‹å·²ä¿å­˜');
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            });
            
            // æ–°å¯¹è¯æŒ‰é’®äº‹ä»¶
            document.getElementById('new-conversation').addEventListener('click', createNewConversation);
            
            // åŠ è½½å¯¹è¯åˆ—è¡¨
            loadConversations();
            
            // ä¿®æ”¹è¡¨å•æäº¤äº‹ä»¶å¤„ç†
            document.getElementById('chat-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                const apiKey = document.getElementById('qwen-api-key').value;
                const modelType = document.getElementById('model-type').value;
                const statusElement = document.getElementById('chat-status');
                
                if (!message) return;
                if (!apiKey) {
                    alert('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
                    return;
                }
                
                // å¤„ç†æ ‡é¢˜ - å–å‰10ä¸ªå­—
                const title = message.length > 10 
                    ? message.substring(0, 10) + '...' 
                    : message;
                
                // å¦‚æœæ²¡æœ‰æ´»è·ƒå¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯å¹¶ä½¿ç”¨æ¶ˆæ¯å†…å®¹ä½œä¸ºæ ‡é¢˜
                if (!currentConversationId) {
                    createNewConversation(title).then(convId => {  // ä¼ å…¥æ ‡é¢˜
                        sendMessageToConversation(convId, message, apiKey, modelType, input, statusElement);
                    });
                } else {
                    sendMessageToConversation(currentConversationId, message, apiKey, modelType, input, statusElement);
                }
            });
        }

        // åŠ è½½æ‰€æœ‰å¯¹è¯åˆ—è¡¨
        function loadConversations() {
            fetch('/api/conversations')
                .then(response => response.json())
                .then(data => {
                    const listContainer = document.getElementById('conversations-list');
                    listContainer.innerHTML = '';
                    
                    if (data.conversations.length === 0) {
                        listContainer.innerHTML = '<div class="p-4 text-gray-500 text-center">æš‚æ— å¯¹è¯è®°å½•</div>';
                        return;
                    }
                    
                    data.conversations.forEach(conv => {
                        const convElement = document.createElement('div');
                        convElement.className = `p-3 border-b hover:bg-gray-50 cursor-pointer ${currentConversationId === conv.id ? 'bg-primary/10' : ''}`;
                        convElement.innerHTML = `
                            <div class="font-medium truncate">${conv.title}</div>
                            <div class="text-xs text-gray-500">${conv.updated_at} (${conv.message_count}æ¡æ¶ˆæ¯)</div>
                            <button class="delete-conv-btn text-red-400 hover:text-red-600 text-xs absolute right-2 top-2 hidden" data-id="${conv.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        `;
                        convElement.setAttribute('data-id', conv.id);
                        
                        // ç‚¹å‡»åˆ‡æ¢å¯¹è¯
                        convElement.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete-conv-btn')) {
                                switchToConversation(conv.id);
                            }
                        });
                        
                        // åˆ é™¤å¯¹è¯æŒ‰é’®
                        convElement.querySelector('.delete-conv-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                                deleteConversation(conv.id);
                            }
                        });
                        
                        listContainer.appendChild(convElement);
                    });
                });
        }
        
        // åˆ›å»ºæ–°å¯¹è¯ï¼ˆä¿®æ”¹ç‰ˆï¼‰
        function createNewConversation(title = 'æ–°å¯¹è¯') {
            return fetch('/api/conversations', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title})  // ä½¿ç”¨ä¼ å…¥çš„æ ‡é¢˜
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadConversations();
                    switchToConversation(data.conversation.id);
                    return data.conversation.id;
                }
                throw new Error('åˆ›å»ºå¯¹è¯å¤±è´¥');
            });
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šå¯¹è¯
        function switchToConversation(convId) {
            currentConversationId = convId;
            
            // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#conversations-list > div').forEach(el => {
                el.classList.toggle('bg-primary/10', el.getAttribute('data-id') == convId);
            });
            
            // åŠ è½½å¯¹è¯æ¶ˆæ¯
            fetch(`/api/conversations/${convId}/messages`)
                .then(response => response.json())
                .then(data => {
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = '';
                    
                    // æ¸²æŸ“æ¶ˆæ¯
                    data.messages.forEach(msg => {
                        addChatMessage(msg.content, msg.role);
                    });
                });
        }

        // åˆ é™¤å¯¹è¯
        function deleteConversation(convId) {
            fetch(`/api/conversations/${convId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (currentConversationId === convId) {
                            currentConversationId = null;
                            document.getElementById('chat-messages').innerHTML = '';
                        }
                        loadConversations();
                    }
                });
        }

        // å‘é€æ¶ˆæ¯åˆ°å½“å‰å¯¹è¯
        function sendMessageToConversation(convId, message, apiKey, modelType, input, statusElement) {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°UI
            addChatMessage(message, 'user');
            input.value = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            statusElement.classList.remove('hidden');
            scrollChatToBottom();

            // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°åç«¯ï¼ˆåç»­é€»è¾‘ä¿æŒä¸å˜ï¼‰
            saveMessageToConversation(convId, 'user', message)
                .then(() => {
                    return callQwenApi(message, apiKey, modelType);
                })
                .then(aiResponse => {
                    addChatMessage(aiResponse, 'ai');
                    return saveMessageToConversation(convId, 'ai', aiResponse);
                })
                .catch(error => {
                    addChatMessage(`å¯¹è¯å¤±è´¥: ${error.message}`, 'ai');
                })
                .finally(() => {
                    statusElement.classList.add('hidden');
                    scrollChatToBottom();
                    loadConversations();
                });
        }

        // ä¿å­˜æ¶ˆæ¯åˆ°å¯¹è¯
        function saveMessageToConversation(convId, role, content) {
            return fetch(`/api/conversations/${convId}/messages`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role, content})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) throw new Error('ä¿å­˜æ¶ˆæ¯å¤±è´¥');
                return data;
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        function scrollChatToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ä¿®æ”¹åŸcallQwenApiå‡½æ•°ï¼ˆä¿æŒä¹‹å‰çš„å®ç°ï¼Œä½¿ç”¨åç«¯ä»£ç†ï¼‰
        function callQwenApi(message, apiKey, modelType) {
            return new Promise((resolve, reject) => {
                fetch('/api/call-qwen', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message, api_key: apiKey, model_type: modelType})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) resolve(data.response);
                    else reject(new Error(data.error || 'APIè°ƒç”¨å¤±è´¥'));
                })
                .catch(error => reject(new Error(`ç½‘ç»œé”™è¯¯ï¼š${error.message}`)));
            });
        }
        
        function addChatMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            
            const messageElement = document.createElement('div');
            messageElement.className = `flex items-start gap-3 ${sender === 'user' ? 'justify-end' : ''}`;
            
            if (sender === 'user') {
                messageElement.innerHTML = `
                    <div class="bg-primary text-white rounded-lg rounded-tr-none p-3 max-w-[80%]">
                        ${content}
                    </div>
                    <div class="bg-gray-200 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fa fa-user text-gray-600"></i>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="bg-gray-200 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fa fa-robot text-gray-600"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg rounded-tl-none p-3 max-w-[80%]">
                        ${content}
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä»…ä¿ç•™å¿…è¦æ•°æ®ï¼Œä½œä¸ºåç«¯å¤‡ä»½ï¼‰
        function saveToLocalStorage() {
            const data = {
                // ä¿ç•™ä¸´æ—¶çŠ¶æ€ï¼ˆè®¡æ—¶å™¨è¿è¡ŒçŠ¶æ€ç­‰ï¼‰
                workGoalTime: workGoalTime,
                remainingTime: remainingTime,
                isTimerRunning: isTimerRunning,
                totalSecondsWorked: totalSecondsWorked,  // ä¿å­˜æ€»å·¥ä½œç§’æ•°ï¼ˆå˜é‡bï¼‰
                // æ ¸å¿ƒæ•°æ®ä»…ä½œä¸ºç¼“å­˜ï¼ˆåç«¯ä¸ºä¸»ï¼‰
                workRecords: workRecords,
                pdfBooks: pdfBooks,
                bookmarks: bookmarks,
                notes: notes
            };
            
            localStorage.setItem('workspaceData', JSON.stringify(data));
            // è®°å½•ä¿å­˜çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('lastSavedDate', today);
        }

        
        // åœ¨ window.addEventListener('load', ...) ä¸­æ·»åŠ 
        function initWorkRecords() {
            fetch('/api/work-records')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.records) {
                        workRecords = data.records;
                        renderWorkRecords();
                        updateTodayStats();
                    }
                })
                .catch((error) => {
                    console.error('åç«¯å·¥ä½œè®°å½•åŠ è½½å¤±è´¥:', error);
                });
        }

        // è°ƒç”¨é¡ºåºè°ƒæ•´
        window.addEventListener('load', function() {
            initNavigation();
            initTimer();
            initBooks(); 
            initMusic();
            initGames();
            initNotes(); 
            initChat();
            initBookmarks(); 
            initWorkRecords(); // æ–°å¢ï¼šä¼˜å…ˆä»åç«¯åŠ è½½å·¥ä½œè®°å½•
            loadFromLocalStorage(); // æœ€ååŠ è½½æœ¬åœ°ç¼“å­˜è¡¥å……
        });
        
        // é¡µé¢å…³é—­å‰ä¿å­˜å½“æ—¥å·¥ä½œæ—¶é—´åˆ°åç«¯
        window.addEventListener('beforeunload', function() {
            // è·å–ä»Šå¤©çš„æ€»å·¥ä½œæ—¶é—´
            const today = new Date().toISOString().split('T')[0];
            const totalHours = totalSecondsWorked / 3600;
            
            // å¦‚æœä»Šå¤©æœ‰å·¥ä½œæ—¶é—´ï¼Œä¿å­˜åˆ°åç«¯
            if (totalHours > 0) {
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                const record = {
                    date: today,
                    time: timeString,
                    hours: parseFloat(totalHours.toFixed(2)),
                    manual: false  // è¡¨ç¤ºè¿™æ˜¯å½“å¤©çš„ç´¯è®¡å·¥ä½œæ—¶é—´ï¼Œä¸æ˜¯æ‰‹åŠ¨æ·»åŠ çš„
                };
                
                // å…ˆåˆ é™¤å½“å¤©çš„éæ‰‹åŠ¨è®°å½•ï¼ˆæ¯å¤©åªä¿ç•™ä¸€æ¡æ€»çš„è®°å½•ï¼‰
                const todayRecords = workRecords.filter(r => r.date === today && r.manual === false);
                todayRecords.forEach(todayRecord => {
                    fetch(`/api/work-records/${todayRecord.id}`, {
                        method: 'DELETE'
                    })
                    .catch(error => console.error('åˆ é™¤æ—§çš„ä»Šæ—¥å·¥ä½œè®°å½•å¤±è´¥:', error));
                });
                
                // ç„¶åæ·»åŠ æ–°çš„è®°å½•
                fetch('/api/work-records', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(record)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('ä»Šæ—¥å·¥ä½œè®°å½•ä¿å­˜æˆåŠŸ');
                    } else {
                        console.error('ä¿å­˜å¤±è´¥:', data.error);
                    }
                })
                .catch(error => console.error('ä¿å­˜ä»Šæ—¥å·¥ä½œè®°å½•å¤±è´¥:', error));
            }
        });
                
    </script>
</body>
</html>